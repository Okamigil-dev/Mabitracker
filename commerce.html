<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Post Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            /* V2.7 Theme from Hub */
            --bg: #09090b;
            --sidebar-bg: #121214;
            --card-bg: #18181b;
            --accent: #00ff88;
            --accent-dim: rgba(0, 255, 136, 0.1);
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-dim: #a1a1aa;
            --warning: #facc15;
            --danger: #ef4444;
        }

        /* --- Global & Reset --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            font-size: 13px;
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- Layout Containers --- */
        .interface-container {
            width: 100%; height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }
        
        .header-bar { 
            background: var(--sidebar-bg); border-bottom: 1px solid var(--border); 
            padding: 10px 20px; flex-shrink: 0;
        }

        .content-grid {
            display: grid; grid-template-columns: 300px 1fr 300px; 
            flex-grow: 1; overflow: hidden; position: relative;
        }
        
        .panel {
            background: var(--bg); overflow-y: auto; display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .panel:last-child { border-right: none; }
        
        .center-panel { background: #0c0c0e; }

        /* --- Header Elements --- */
        .title-section {
            display: flex; justify-content: space-between; align-items: center; max-width: 1500px; margin: 0 auto; width: 100%;
        }
        .main-title {
            font-size: 16px; font-weight: 700; color: #fff; letter-spacing: 0.5px;
        }
        .sub-title { 
            font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-left: 10px;
        }
        .hub-btn {
            color: var(--text-dim); text-decoration: none; font-weight: 600; font-size: 12px;
            padding: 6px 12px; border-radius: 6px; transition: 0.2s; border: 1px solid transparent;
        }
        .hub-btn:hover { color: #fff; background: var(--border); }

        /* --- Form Elements --- */
        .panel-label {
            font-size: 11px; font-weight: 600; color: var(--text-dim);
            margin-bottom: 6px; display: block;
        }
        
        .input-dark {
            background: var(--card-bg); border: 1px solid var(--border); color: #fff;
            font-family: 'Inter', sans-serif; font-size: 13px; padding: 8px; border-radius: 6px;
            width: 100%; transition: border-color 0.2s;
        }
        .input-dark:focus { border-color: var(--accent); }
        
        select.input-dark { cursor: pointer; }

        /* --- Left Panel Items --- */
        .config-section { padding: 20px; border-bottom: 1px solid var(--border); }
        
        .item-list { flex-grow: 1; overflow-y: auto; }
        
        .inventory-item {
            display: flex; gap: 12px; padding: 10px 15px;
            border-bottom: 1px solid var(--border); cursor: pointer;
            align-items: center; transition: 0.15s;
        }
        .inventory-item:hover { background: var(--card-bg); }
        .selected-item { background: var(--accent-dim); border-left: 3px solid var(--accent); }
        
        .item-icon-box {
            width: 40px; height: 40px; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 4px; background-size: contain; background-repeat: no-repeat; 
            background-position: center; flex-shrink: 0;
        }
        .item-name { font-weight: 600; font-size: 13px; color: #fff; }
        .item-meta { font-size: 11px; color: var(--text-dim); }
        .stock-input-row { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
        
        /* --- Center Panel --- */
        .item-header {
            padding: 30px; border-bottom: 1px solid var(--border); display: flex;
            gap: 20px; align-items: center; background: var(--card-bg); flex-shrink: 0;
        }
        .big-icon {
            width: 80px; height: 80px; background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        .item-title-large { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        
        .market-row {
            display: grid; grid-template-columns: 1.5fr 1fr 1fr 0.8fr;
            padding: 12px 20px; border-bottom: 1px solid var(--border);
            align-items: center; gap: 15px; font-size: 13px;
        }
        .market-row.head { background: var(--card-bg); font-weight: 600; color: var(--text-dim); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 10; }
        
        .profit-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; text-align: right; color: var(--accent); }
        .profit-val.negative { color: var(--danger); }
        .score-val { font-family: 'JetBrains Mono', monospace; text-align: right; color: var(--text-dim); }

        /* --- Right Panel & Toggles --- */
        .toggle-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 0; cursor: pointer;
        }
        .toggle-label { font-size: 13px; color: var(--text-main); }
        
        .toggle-switch {
            width: 36px; height: 20px; background: var(--border); border-radius: 99px;
            position: relative; transition: 0.2s;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px;
            background: #fff; border-radius: 50%; transition: 0.2s;
        }
        input:checked + .toggle-switch { background: var(--accent); }
        input:checked + .toggle-switch::after { transform: translateX(16px); }
        
        /* --- Manifest Box --- */
        .manifest-container {
            margin: 20px; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 8px; padding: 15px;
        }
        .manifest-header {
            font-size: 11px; font-weight: 700; color: var(--accent); text-transform: uppercase;
            margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between;
        }
        .manifest-slots { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; }
        .slot {
            width: 36px; height: 36px; background: var(--bg); border: 1px solid var(--border);
            border-radius: 4px; background-size: contain; background-repeat: no-repeat;
            background-position: center; position: relative;
        }
        .slot.filled { border-color: var(--accent); background-color: var(--accent-dim); }
        .slot-badge {
            position: absolute; bottom: -2px; right: -2px; background: var(--accent); color: #000;
            font-size: 9px; font-weight: 700; padding: 0 3px; border-radius: 2px;
        }
        .manifest-total { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #fff; text-align: right; }

        /* --- MOBILE STYLES --- */
        .mobile-nav { display: none; }
        .mobile-backdrop { display: none; }

        @media (max-width: 1000px) {
            .content-grid { display: block; height: calc(100vh - 50px); }
            .header-bar { display: none; } /* Hide desktop header */
            
            /* Mobile Nav Bar */
            .mobile-nav {
                display: flex; justify-content: space-between; align-items: center;
                padding: 10px 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border);
                height: 50px; z-index: 50; flex-shrink: 0;
            }
            .nav-trigger {
                background: transparent; border: 1px solid var(--border); color: var(--text-main);
                padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
            }
            
            /* Drawers */
            .left-panel, .right-panel {
                position: fixed; top: 0; bottom: 0; width: 300px; max-width: 85%;
                z-index: 1001; box-shadow: 0 0 50px rgba(0,0,0,0.8);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .left-panel { left: 0; transform: translateX(-100%); border-right: 1px solid var(--border); }
            .left-panel.active { transform: translateX(0); }
            
            .right-panel { right: 0; transform: translateX(100%); border-left: 1px solid var(--border); }
            .right-panel.active { transform: translateX(0); }
            
            /* Backdrop */
            .mobile-backdrop {
                display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
                z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
                backdrop-filter: blur(4px);
            }
            .mobile-backdrop.active { opacity: 1; pointer-events: all; }
            
            .center-panel { height: 100%; width: 100%; border: none; }
            .item-header { padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- Mobile Nav -->
    <div class="mobile-nav">
        <button class="nav-trigger" onclick="toggleSidebar('left')">☰ Items</button>
        <span style="font-weight:700; color:#fff;">Commerce</span>
        <button class="nav-trigger" onclick="toggleSidebar('right')">Settings</button>
    </div>

    <!-- Backdrop -->
    <div class="mobile-backdrop" id="mobile-backdrop" onclick="closeSidebars()"></div>

    <div class="interface-container">
        <!-- Desktop Header -->
        <div class="header-bar">
            <div class="title-section">
                <div style="display:flex; align-items:center;">
                    <span class="main-title">TRADING POST</span>
                    <span class="sub-title">SYNC_V2.7</span>
                </div>
                <a href="index.html" class="hub-btn">Back to Hub</a>
            </div>
        </div>

        <div class="content-grid">
            <!-- LEFT PANEL: Config & Items -->
            <div class="panel left-panel" id="left-panel">
                <div class="config-section">
                    <div style="margin-bottom: 15px;">
                        <label class="panel-label">Commerce Mode</label>
                        <select id="commerce-type-select" class="input-dark">
                            <option value="Normal">Normal Commerce</option>
                            <option value="Barter">Bartering</option>
                            <option value="Group">Group Commerce</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1;">
                            <label class="panel-label">Transport</label>
                            <select id="transport-dropdown" class="input-dark"></select>
                        </div>
                        <div style="width:80px;">
                             <label class="panel-label">Rating</label>
                             <select id="merchant-rating-select" class="input-dark">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                            </select>
                        </div>
                    </div>

                    <div style="position: relative;">
                        <input type="text" id="global-search" class="input-dark" placeholder="Search items...">
                        <div id="clear-search" style="position: absolute; right: 10px; top: 8px; cursor: pointer; display: none; color: #666;">✕</div>
                    </div>
                </div>

                <!-- Player Avatar / Town Info -->
                <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px;">
                    <div class="player-avatar" id="origin-town-icon"></div>
                    <div style="flex-grow:1;">
                        <label class="panel-label" style="margin:0;">Current Post</label>
                        <select id="city-select" class="input-dark" style="margin-top:4px;"></select>
                    </div>
                </div>
                
                <!-- Items List -->
                <div id="market-items-container" class="item-list"></div>
            </div>

            <!-- CENTER PANEL: Data -->
            <div class="panel center-panel">
                <div class="item-header">
                    <div class="big-icon" id="center-item-icon"></div>
                    <div class="item-title-box">
                        <div class="item-title-large" id="center-item-title">Select Item</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="item-meta" id="max-inventory-display">...</div>
                            <div id="base-price-container" style="display:none; align-items: center; gap: 8px;">
                                <span style="font-size: 10px; color: var(--text-dim); font-weight: 600;">BASE</span>
                                <input type="number" id="base-price-input" class="input-dark" style="width: 70px; text-align: right; padding: 4px;" onchange="updateBasePrice(this.value)" onfocus="this.select()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="market-list-container">
                    <div class="market-row head">
                        <div>Target</div>
                        <div style="text-align:right;">Sell Price</div>
                        <div style="text-align:right;">Profit</div>
                        <div style="text-align:right;">Score</div>
                    </div>
                    <div id="profit-list"></div>
                </div>
            </div>

            <!-- RIGHT PANEL: Modifiers & Routes -->
            <div class="panel right-panel" id="right-panel">
                <div class="config-section">
                    <label class="panel-label" style="color:var(--accent);">PROFIT MODIFIERS</label>
                    <div style="margin-bottom:10px;">
                        <select id="mastery-rank" class="input-dark" style="margin-bottom:8px;"></select>
                        <div style="display:flex; gap:8px;">
                            <select id="letter-select" class="input-dark" style="flex:1;"></select>
                            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                                <input type="checkbox" id="fine-letter-check"> <span style="font-size:11px; color:#aaa;">Fine</span>
                            </label>
                        </div>
                    </div>

                    <label class="panel-label" style="color:var(--accent); margin-top:20px;">GEAR & PARTNERS</label>
                    
                    <div class="toggle-row">
                        <span class="toggle-label">Grandmaster Merchant</span>
                        <label><input type="checkbox" id="gm-check" style="display:none;"><div class="toggle-switch"></div></label>
                    </div>

                    <div class="toggle-row">
                        <span class="toggle-label">Alpaca</span>
                        <label><input type="checkbox" id="alpaca-check" style="display:none;"><div class="toggle-switch"></div></label>
                    </div>

                    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:5px;">
                        <div class="toggle-row" style="flex:1;">
                            <span class="toggle-label">William</span>
                            <label style="margin-left:10px;"><input type="checkbox" id="william-check" style="display:none;"><div class="toggle-switch"></div></label>
                        </div>
                        <div id="william-like-box" style="display:none; align-items:center; gap:5px;">
                            <span style="font-size:10px; color:#666;">Likeability</span>
                            <input type="number" id="william-likeability" class="input-dark" style="width:50px; padding:4px; text-align:center;" value="247">
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label class="panel-label">Trader Gear</label>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span class="toggle-label">Gear</span>
                            <input type="number" id="trader-qty" class="input-dark" style="width:50px; text-align:center;" min="0" max="2" value="0">
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span class="toggle-label">Trustworthy</span>
                            <input type="number" id="trustworthy-qty" class="input-dark" style="width:50px; text-align:center;" min="0" max="2" value="0">
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <label class="panel-label">OWNED TRANSPORTS</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0 15px;">
                        <div class="toggle-row"><span class="toggle-label">Hand Cart</span><label><input type="checkbox" id="handcart-check" class="transport-toggle" data-mount="Hand Cart" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Wagon</span><label><input type="checkbox" id="wagon-check" class="transport-toggle" data-mount="Wagon" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Elephant</span><label><input type="checkbox" id="elephant-check" class="transport-toggle" data-mount="Elephant" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Husky</span><label><input type="checkbox" id="husky-check" class="transport-toggle" data-mount="Husky" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Camel</span><label><input type="checkbox" id="camel-check" class="transport-toggle" data-mount="Camel" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Skiff</span><label><input type="checkbox" id="skiff-check" class="transport-toggle" data-mount="Skiff" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Air Ship</span><label><input type="checkbox" id="airship-check" class="transport-toggle" data-mount="Air Ship" style="display:none;"><div class="toggle-switch"></div></label></div>
                    </div>
                </div>

                <div class="manifest-container" id="manifest-box" style="display:none;">
                    <div class="manifest-header">
                        <span>Local Best Route</span>
                        <span id="manifest-dest" style="color:#fff;">Dest</span>
                    </div>
                    <div id="manifest-list" class="manifest-slots"></div>
                    <div id="manifest-total" class="manifest-total"></div>
                </div>

                <div id="global-manifest-anchor"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & DATA (HARDCODED) ---
        function getImagePath(path) {
            if (!path) return "";
            return (path.startsWith('images/') || path.startsWith('http')) ? path : `images/${path}`;
        }
        
        const townIcons={"Tir Chonaill":"tradeposts/Commerce_Tir_Chonaill_Icon.png","Dunbarton":"tradeposts/Commerce_Dunbarton_Icon.png","Bangor":"tradeposts/Commerce_Bangor_Icon.png","Emain Macha":"tradeposts/Commerce_Emain_Macha_Icon.png","Taillteann":"tradeposts/Commerce_Taillteann_Icon.png","Tara":"tradeposts/Commerce_Tara_Icon.png","Cobh":"tradeposts/Commerce_Port_Cobh_Icon.png","Belvast":"tradeposts/Commerce_Commonwealth_of_Belvast_Icon.png","Qilla":"tradeposts/Commerce_Qilla_Icon.png","Cor":"tradeposts/Commerce_Cor_Icon.png","Vales":"tradeposts/Commerce_Vales_Icon.png","Filia":"tradeposts/Commerce_Filia_Icon.png","Karu Forest":"tradeposts/Commerce_Karu_Forest_Icon.png","Oasis":"tradeposts/Commerce_Oasis_Icon.png","Lake Calida":"tradeposts/Commerce_Calida_Icon.png","Pera Volcano":"tradeposts/Commerce_Pera_Icon.png","Scathach Beach":"tradeposts/Commerce_Beach_of_Scathach_Icon.png"};
        const transportData={"Back Pack":{slots:4,weight:400},"Hand Cart":{slots:6,weight:800},"Wagon":{slots:8,weight:900},"Elephant":{slots:7,weight:1700},"Husky":{slots:11,weight:700},"Camel":{slots:7,weight:1400},"Skiff":{slots:8,weight:1200},"Air Ship":{slots:18,weight:2500}};
        const citiesByType={"Normal":["Tir Chonaill","Dunbarton","Bangor","Emain Macha","Taillteann","Tara","Cobh","Belvast","Qilla","Cor","Vales","Filia"],"Barter":["Karu Forest","Oasis","Lake Calida","Pera Volcano","Scathach Beach"],"Group":["Qilla","Filia","Cor","Vales"]};
        const masteryRanks={"1":0.15,"2":0.14,"3":0.13,"4":0.12,"5":0.11,"6":0.10,"7":0.09,"8":0.08,"9":0.07,"A":0.06,"B":0.05,"C":0.04,"D":0.03,"E":0.02,"F":0.01};
        const guaranteeLetters={"None":{normal:0,barter:0,fine_normal:0,fine_barter:0},"Ogre":{normal:0.30,barter:0.15,fine_normal:0.90,fine_barter:0.45},"Goblin":{normal:0.40,barter:0.20,fine_normal:1.20,fine_barter:0.60},"Imp":{normal:0.50,barter:0.25,fine_normal:1.50,fine_barter:0.75},"Irusan's (Special)":{normal:3.00,barter:0.75,fine_normal:3.00,fine_barter:0.75}};
        const marketData={
            "Normal":{
                "Tir Chonaill":[{"name":"Baby Potion","buy":11,"weight":1,"max":35,"limit":Infinity,"img":"tradeposts/normal/tir/Baby_Potion_Icon.png"},{"name":"Diet Potion","buy":26,"weight":1,"max":30,"limit":Infinity,"img":"tradeposts/normal/tir/Diet_Potion_Icon.png"},{"name":"Snore Potion","buy":62,"weight":2,"max":26,"limit":Infinity,"img":"tradeposts/normal/tir/Snore_Prevention_Potion_Icon.png"},{"name":"Ginseng","buy":134,"weight":3,"max":22,"limit":Infinity,"img":"tradeposts/normal/tir/Wild_Ginseng_Potion_Icon.png"},{"name":"Lovely Potion","buy":158,"weight":3,"max":25,"limit":Infinity,"img":"tradeposts/normal/tir/Lovely_Potion_Icon.png"}],
                "Dunbarton":[{"name":"Spider Gloves","buy":44,"weight":4,"max":14,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Spider_Gloves_Icon.png"},{"name":"Wool Boots","buy":160,"weight":8,"max":10,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Wool_Boots_Icon.png"},{"name":"Ogre Mask","buy":91,"weight":4,"max":26,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Ogre_Executioner_Mask_Icon.png"},{"name":"Incubus Suit","buy":536,"weight":25,"max":5,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Incubus_Suit_Icon.png"},{"name":"Succubus Swimsuit","buy":718,"weight":6,"max":5,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Succubus_Swimsuit_Icon.png"}],
                "Bangor":[{"name":"Bangor Coal","buy":45,"weight":8,"max":10,"limit":Infinity,"img":"tradeposts/normal/bangor/Bangor_Coal_Icon.png"},{"name":"Marble","buy":301,"weight":20,"max":10,"limit":Infinity,"img":"tradeposts/normal/bangor/Marble_Icon.png"},{"name":"Topaz","buy":376,"weight":18,"max":12,"limit":Infinity,"img":"tradeposts/normal/bangor/Topaz_Icon.png"},{"name":"Highlander Ore","buy":788,"weight":25,"max":8,"limit":Infinity,"img":"tradeposts/normal/bangor/Highlander_Ore_Icon.png"},{"name":"Lead","buy":856,"weight":18,"max":16,"limit":Infinity,"img":"tradeposts/normal/bangor/Lead_Icon.png"}],
                "Emain Macha":[{"name":"Berry Granola","buy":10,"weight":3,"max":25,"limit":Infinity,"img":"tradeposts/normal/emain/Berry_Granola_Icon.png"},{"name":"Butter Beer","buy":49,"weight":4,"max":30,"limit":Infinity,"img":"tradeposts/normal/emain/Butter_Beer_Icon.png"},{"name":"Smoked Animal","buy":190,"weight":10,"max":40,"limit":Infinity,"img":"tradeposts/normal/emain/Smoked_Wild_Animal_Icon.png"},{"name":"Triple Pasta","buy":94,"weight":4,"max":32,"limit":Infinity,"img":"tradeposts/normal/emain/Triple_Pasta_Icon.png"},{"name":"Whole BBQ","buy":630,"weight":14,"max":12,"limit":Infinity,"img":"tradeposts/normal/emain/Whole_BBQ_Bear_Icon.png"}],
                "Taillteann":[{"name":"Heat Crystal","buy":11,"weight":2,"max":33,"limit":Infinity,"img":"tradeposts/normal/taillteann/Heat_Crystal_Icon.png"},{"name":"Music Box Stone","buy":37,"weight":3,"max":24,"limit":Infinity,"img":"tradeposts/normal/taillteann/Music_Box_Preservation_Stone_Icon.png"},{"name":"Palala Crystal","buy":130,"weight":6,"max":38,"limit":Infinity,"img":"tradeposts/normal/taillteann/Palala_Crystal_Icon.png"},{"name":"Circle Barrier Spikes","buy":126,"weight":3,"max":30,"limit":Infinity,"img":"tradeposts/normal/taillteann/Circle_Barrier_Spike_Crystal_Icon.png"},{"name":"Alchemy Crystal","buy":720,"weight":5,"max":8,"limit":Infinity,"img":"tradeposts/normal/taillteann/Alchemy_Crystal_Icon.png"}],
                "Tara":[{"name":"Mini Dressing Table","buy":205,"weight":15,"max":10,"limit":Infinity,"img":"tradeposts/normal/tara/Mini_Dressing_Table_Icon.png"},{"name":"Tea Table","buy":896,"weight":38,"max":3,"limit":Infinity,"img":"tradeposts/normal/tara/Tea_Table_Icon.png"},{"name":"Rocking Chair","buy":918,"weight":25,"max":5,"limit":Infinity,"img":"tradeposts/normal/tara/Rocking_Chair_Icon.png"},{"name":"Bunk Bed","buy":3690,"weight":60,"max":3,"limit":Infinity,"img":"tradeposts/normal/tara/Bunk_Bed_Icon.png"},{"name":"Giant Wine Rack","buy":8640,"weight":90,"max":2,"limit":Infinity,"img":"tradeposts/normal/tara/Giant_Wine_Rack_Icon.png"}],
                "Cobh":[{"name":"Cobh Seaweed","buy":11,"weight":2,"max":32,"limit":Infinity,"img":"tradeposts/normal/cobh/Cobh_Seaweed_Icon.png"},{"name":"Cobh Oyster","buy":46,"weight":3,"max":26,"limit":Infinity,"img":"tradeposts/normal/cobh/Cobh_Oyster_Icon.png"},{"name":"Shark Fin","buy":264,"weight":10,"max":25,"limit":Infinity,"img":"tradeposts/normal/cobh/Shark_Fin_Icon.png"},{"name":"Jellyfish","buy":201,"weight":6,"max":30,"limit":Infinity,"img":"tradeposts/normal/cobh/Jelly_Fish_Icon.png"},{"name":"Neid Scale","buy":187,"weight":2,"max":28,"limit":Infinity,"img":"tradeposts/normal/cobh/Neid_Scales_Icon.png"}],
                "Belvast":[{"name":"Iron Whip","buy":103,"weight":8,"max":15,"limit":Infinity,"img":"tradeposts/normal/belvast/Iron_Whip_Icon.png"},{"name":"Dark Sword","buy":477,"weight":12,"max":10,"limit":Infinity,"img":"tradeposts/normal/belvast/Dark_Sword_Icon.png"},{"name":"Safe","buy":9757,"weight":90,"max":2,"limit":Infinity,"img":"tradeposts/normal/belvast/Safe_Icon.png"},{"name":"Skeleton Armour","buy":15546,"weight":115,"max":1,"limit":Infinity,"img":"tradeposts/normal/belvast/Skeleton_Ogre_Armor_Icon.png"},{"name":"Fake Helmet","buy":4740,"weight":30,"max":6,"limit":Infinity,"img":"tradeposts/normal/belvast/Fake_Morgant_Helmet_Icon.png"}],
                "Qilla":[{"name":"Mint Chocolate Powder","buy":35,"weight":1,"max":60,"limit":Infinity,"img":"tradeposts/normal/qilla/Mint_Chocolate_Powder_Icon.png"},{"name":"Pomegranate","buy":58,"weight":2,"max":50,"limit":Infinity,"img":"tradeposts/normal/qilla/Fresh_Pomegranate_Icon.png"},{"name":"Mana Tunnel Figure","buy":102,"weight":2,"max":65,"limit":Infinity,"img":"tradeposts/normal/qilla/Mana_Tunnel_Figure_Icon.png"},{"name":"Exploration Rescue Kit","buy":247,"weight":3,"max":38,"limit":Infinity,"img":"tradeposts/normal/qilla/Exploration_Rescue_Kit_Icon.png"},{"name":"Kaypi Cactus Essence","buy":566,"weight":2,"max":26,"limit":Infinity,"img":"tradeposts/normal/qilla/Kaypi_Cactus_Essence_Icon.png"}],
                "Filia":[{"name":"Small Glass Chunk","buy":72,"weight":10,"max":60,"limit":Infinity,"img":"tradeposts/normal/filia/Small_Glass_Chunk_Icon.png"},{"name":"Cinnamon Perfume","buy":564,"weight":22,"max":15,"limit":Infinity,"img":"tradeposts/normal/filia/Cinnamon_Perfume_Icon.png"},{"name":"Dried Saffron","buy":906,"weight":25,"max":10,"limit":Infinity,"img":"tradeposts/normal/filia/Dried_Saffron_Icon.png"},{"name":"Longa Rock Salt","buy":2342,"weight":40,"max":5,"limit":Infinity,"img":"tradeposts/normal/filia/Longa_Natural_Rock_Salt_Icon.png"},{"name":"Filia Jerky","buy":1567,"weight":20,"max":12,"limit":Infinity,"img":"tradeposts/normal/filia/Filia_Jerky_Icon.png"}],
                "Cor":[{"name":"Courcle Ruins Souvenir","buy":8,"weight":2,"max":50,"limit":Infinity,"img":"tradeposts/normal/cor/Courcle_Ruins_Souvenir_Icon.png"},{"name":"Large Ritual Mask","buy":61,"weight":3,"max":40,"limit":Infinity,"img":"tradeposts/normal/cor/Large_Ritual_Mask_Icon.png"},{"name":"La Terra Raspberry","buy":56,"weight":2,"max":60,"limit":Infinity,"img":"tradeposts/normal/cor/La_Terra_Raspberry_Icon.png"},{"name":"Artifact Rest. Tool","buy":81,"weight":2,"max":70,"limit":Infinity,"img":"tradeposts/normal/cor/Artifact_Restoration_Tool_Set_Icon.png"},{"name":"Courcle Natural Rubber","buy":935,"weight":5,"max":8,"limit":Infinity,"img":"tradeposts/normal/cor/Courcle_Natural_Rubber_Icon.png"}],
                "Vales":[{"name":"Vales Coat","buy":30,"weight":1,"max":50,"limit":Infinity,"img":"tradeposts/normal/vales/Vales_Padded_Coat_Icon.png"},{"name":"Glacial Water","buy":118,"weight":2,"max":35,"limit":Infinity,"img":"tradeposts/normal/vales/Natural_Glacial_Water_Icon.png"},{"name":"Ice Skates","buy":216,"weight":1,"max":50,"limit":Infinity,"img":"tradeposts/normal/vales/Ice_Skates_Icon.png"},{"name":"Snowboard","buy":1079,"weight":3,"max":20,"limit":Infinity,"img":"tradeposts/normal/vales/Snowboard_Icon.png"},{"name":"Vales Vodka","buy":1204,"weight":2,"max":16,"limit":Infinity,"img":"tradeposts/normal/vales/Vales_Vodka_Icon.png"}]
            },
            "Barter":{
                "Karu Forest":[{"name":"Wooden Table","buy":0,"weight":15,"max":10,"limit":25,"img":"tradeposts/barter/karu/Wooden_Table_Icon.png"},{"name":"Wooden Craft","buy":0,"weight":15,"max":7,"limit":15,"img":"tradeposts/barter/karu/Wooden_Craft_Icon.png"},{"name":"Stone Horse Statue","buy":0,"weight":20,"max":7,"limit":10,"img":"tradeposts/barter/karu/Stone_Horse_Statue_Icon.png"},{"name":"Karu Mushroom","buy":0,"weight":25,"max":7,"limit":8,"img":"tradeposts/barter/karu/Karu_Shiitake_Mushroom_Icon.png"},{"name":"Shellfish Fossil","buy":0,"weight":30,"max":5,"limit":3,"img":"tradeposts/barter/karu/Shellfish_Fossil_Icon.png"}],
                "Oasis":[{"name":"Fine Sand","buy":0,"weight":15,"max":10,"limit":25,"img":"tradeposts/barter/oasis/Fine_Sand_Icon.png"},{"name":"Prison Ghost Wings","buy":0,"weight":15,"max":7,"limit":15,"img":"tradeposts/barter/oasis/Prison_Ghost_Wings_Icon.png"},{"name":"Oasis Painting","buy":0,"weight":20,"max":7,"limit":10,"img":"tradeposts/barter/oasis/Oasis_Painting_Icon.png"},{"name":"Cactus Flower","buy":0,"weight":25,"max":7,"limit":8,"img":"tradeposts/barter/oasis/Cactus_Flower_Icon.png"},{"name":"Giant Canine Fossil","buy":0,"weight":30,"max":5,"limit":3,"img":"tradeposts/barter/oasis/Giant_Canine_Fossil_Icon.png"}],
                "Lake Calida":[{"name":"Elvan Egg","buy":0,"weight":15,"max":10,"limit":25,"img":"tradeposts/barter/calida/Elvan_Egg_Icon.png"},{"name":"Salmon","buy":0,"weight":15,"max":7,"limit":15,"img":"tradeposts/barter/calida/Calida_Salmon_Icon.png"},{"name":"Bath Bomb","buy":0,"weight":20,"max":7,"limit":10,"img":"tradeposts/barter/calida/Hot_Spring_Bath_Bomb_Icon.png"},{"name":"Large Tent","buy":0,"weight":25,"max":7,"limit":8,"img":"tradeposts/barter/calida/Large_Camping_Tent_Icon.png"},{"name":"Pink Salt","buy":0,"weight":30,"max":5,"limit":3,"img":"tradeposts/barter/calida/Pink_Salt_Icon.png"}],
                "Pera Volcano":[{"name":"Mud Pack","buy":0,"weight":15,"max":10,"limit":25,"img":"tradeposts/barter/pera/Volcanic_Mud_Pack_Icon.png"},{"name":"Magma Stone","buy":0,"weight":15,"max":7,"limit":15,"img":"tradeposts/barter/pera/Magma_Stone_Icon.png"},{"name":"Ixion Horn","buy":0,"weight":20,"max":7,"limit":10,"img":"tradeposts/barter/pera/Ixion_Horn_Icon.png"},{"name":"Lizard Egg","buy":0,"weight":25,"max":7,"limit":8,"img":"tradeposts/barter/pera/Volcano_Lizard_Egg_Icon.png"},{"name":"Leopard Leather","buy":0,"weight":30,"max":5,"limit":3,"img":"tradeposts/barter/pera/Raspa_Black_Leopard_Leather_Icon.png"}],
                "Scathach Beach":[{"name":"Ocean Tear","buy":0,"weight":7,"max":15,"limit":100,"img":"tradeposts/barter/scathach/Ocean_Tear.png"},{"name":"Alluring Stem","buy":0,"weight":15,"max":10,"limit":100,"img":"tradeposts/barter/scathach/Allure_Stem.png"},{"name":"Abyss Crystal","buy":0,"weight":5,"max":15,"limit":100,"img":"tradeposts/barter/scathach/Abyss_Crystal.png"},{"name":"Sage Crystal","buy":0,"weight":10,"max":15,"limit":100,"img":"tradeposts/barter/scathach/Sage_Crystal.png"},{"name":"River's Source","buy":0,"weight":25,"max":10,"limit":100,"img":"tradeposts/barter/scathach/River_Source.png"},{"name":"Night Leather","buy":0,"weight":4,"max":30,"limit":100,"img":"tradeposts/barter/scathach/Night_Sky_Leather.png"},{"name":"Fish","buy":0,"weight":5,"max":20,"limit":100,"img":"tradeposts/barter/scathach/Unidentified_Fish.png"},{"name":"Crystal Blade","buy":0,"weight":15,"max":10,"limit":100,"img":"tradeposts/barter/scathach/Crystal_Blade.png"}]
            },
            "Group":{
                "Qilla":[{"name":"Building Lumber","buy":571,"weight":15,"max":8,"limit":144,"img":"tradeposts/group/qilla/Building_Lumber_Icon.png"},{"name":"Ancient Fossil Specimen","buy":550,"weight":8,"max":10,"limit":180,"img":"tradeposts/group/qilla/Ancient_Fossil_Specimen_Icon.png"},{"name":"Personal Camping Tent","buy":951,"weight":20,"max":7,"limit":125,"img":"tradeposts/group/qilla/Personal_Camping_Tent_Icon.png"},{"name":"Lutra Freshwater Eel","buy":657,"weight":7,"max":11,"limit":198,"img":"tradeposts/group/qilla/Lutra_Freshwater_Eel_Icon.png"},{"name":"Kaypi Red Clay","buy":919,"weight":6,"max":8,"limit":144,"img":"tradeposts/group/qilla/Kaypi_Red_Clay_Icon.png"}],
                "Filia":[{"name":"Sun Hourglass","buy":2003,"weight":70,"max":12,"limit":35,"img":"tradeposts/group/filia/Sun_Hourglass_Icon.png"},{"name":"Shyllien Icebox","buy":3724,"weight":120,"max":5,"limit":20,"img":"tradeposts/group/filia/Shyllien_Icebox_Icon.png"},{"name":"Desert-Terrain Wheel","buy":3078,"weight":90,"max":7,"limit":25,"img":"tradeposts/group/filia/Desert-Terrain_Wheel_Icon.png"},{"name":"Filia Traditional Carpet","buy":1486,"weight":35,"max":20,"limit":71,"img":"tradeposts/group/filia/Filia_Traditional_Carpet_Icon.png"},{"name":"Gem Parasol","buy":905,"weight":20,"max":25,"limit":125,"img":"tradeposts/group/filia/Gem_Parasol_Icon.png"}],
                "Cor":[{"name":"Lipai Pattern Textile","buy":342,"weight":6,"max":15,"limit":270,"img":"tradeposts/group/cor/Lipai_Pattern_Textile_Icon.png"},{"name":"Cor Honeycomb","buy":474,"weight":12,"max":13,"limit":208,"img":"tradeposts/group/cor/Cor_Honeycomb_Icon.png"},{"name":"Swamp Ash","buy":717,"weight":18,"max":9,"limit":138,"img":"tradeposts/group/cor/Swamp_Ash_Icon.png"},{"name":"Rosewood","buy":1084,"weight":25,"max":10,"limit":100,"img":"tradeposts/group/cor/Rosewood_Icon.png"},{"name":"Ebony","buy":1358,"weight":28,"max":8,"limit":89,"img":"tradeposts/group/cor/Ebony_Icon.png"}],
                "Vales":[{"name":"Calida Flint","buy":503,"weight":5,"max":10,"limit":180,"img":"tradeposts/group/vales/Calida_Flint_Icon.png"},{"name":"Physis Sled","buy":1238,"weight":10,"max":5,"limit":90,"img":"tradeposts/group/vales/Physis_Sled_Icon.png"},{"name":"Portable Hand Warmer","buy":723,"weight":2,"max":10,"limit":180,"img":"tradeposts/group/vales/Portable_Hand_Warmer_Icon.png"},{"name":"Ice Statue","buy":982,"weight":8,"max":8,"limit":144,"img":"tradeposts/group/vales/Ice_Statue_Icon.png"},{"name":"Hillwen Commemorative Coin","buy":604,"weight":4,"max":15,"limit":270,"img":"tradeposts/group/vales/Hillwen_Commemorative_Coin_Icon.png"}]
            }
        };

        // --- 2. STATE ---
        let currentItem = null;
        let publicPrices = {};
        let publicStocks = {};
        let publicBasePrices = {};
        let townRanks = {}; 
        let transportOwnership = { "Hand Cart": false, "Wagon": false, "Elephant": false, "Husky": false, "Camel": false, "Skiff": false, "Air Ship": false };

        let currentUser = null;
        let saveTimeout = null;
        let rtdb = null;
        let auth = null;
        let skipRender = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- 3. LOGIC ---
        function getStock(itemName) { return publicStocks[itemName] || 0; }
        function getPrice(itemName, city) { return publicPrices[`${itemName}_${city}`.replace(/[.#$[\]]/g, "_")] || 0; }

        function getUIState() {
            return {
                commerceType: document.getElementById('commerce-type-select').value,
                transport: document.getElementById('transport-dropdown').value,
                merchantRating: parseInt(document.getElementById('merchant-rating-select').value, 10) || 1,
                trader: parseInt(document.getElementById('trader-qty').value, 10) || 0,
                trust: parseInt(document.getElementById('trustworthy-qty').value, 10) || 0,
                mastery: document.getElementById('mastery-rank').value,
                letter: document.getElementById('letter-select').value,
                fine: document.getElementById('fine-letter-check').checked,
                gm: document.getElementById('gm-check').checked,
                william: document.getElementById('william-check').checked,
                williamLike: parseInt(document.getElementById('william-likeability').value) || 0,
                alpaca: document.getElementById('alpaca-check').checked
            };
        }

        function getDiscountedBuyPrice(base, uiState) {
            const r = uiState.merchantRating;
            const mD = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 1, 6: 1, 7: 2, 8: 2, 9: 3 }[r] || 0;
            const gear = (uiState.trader * 3) + uiState.trust;
            return Math.floor(base * (1 - ((mD + gear) / 100)));
        }

        function getModifiedStats(mName, uiState) {
            const b = transportData[mName];
            if (!b) return { slots: 0, weight: 0 };
            let bW = 0, bS = 0;
            if (uiState.gm) { bW += 100; bS += 1; }
            if (mName !== "Air Ship" && uiState.william) { bW += 200; bS += 1; }
            if (mName === "Wagon" && uiState.alpaca) { bW += 200; bS += 2; }
            return { slots: b.slots + bS, weight: b.weight + bW };
        }

        function getActiveModifiers(uiState) {
            const masteryBonus = masteryRanks[uiState.mastery] || 0;
            const letterInfo = guaranteeLetters[uiState.letter] || guaranteeLetters["None"];
            let letterMultiplier = (uiState.commerceType === "Barter") ? (uiState.fine ? letterInfo.fine_barter : letterInfo.barter) : (uiState.fine ? letterInfo.fine_normal : letterInfo.normal);
            let williamBonus = 0;
            if (uiState.william) {
                const like = uiState.williamLike;
                if (like >= 240) williamBonus = 0.03;
                else if (like >= 130) williamBonus = 0.02;
                else if (like >= 80) williamBonus = 0.01;
            }
            return { totalMultiplier: (1 + masteryBonus + letterMultiplier + williamBonus) };
        }

        function calculateItemProfit(item, targetCity, uiState, sellPriceOverride = null) {
            const sellVal = sellPriceOverride !== null ? sellPriceOverride : getPrice(item.name, targetCity);
            const basePrice = publicBasePrices[item.name] || item.buy;
            const dBuy = getDiscountedBuyPrice(basePrice, uiState);
            const stats = getModifiedStats(uiState.transport, uiState);
            const load = Math.min(Math.floor(stats.weight / item.weight), stats.slots * item.max, item.limit);
            const baseProfit = (sellVal !== "") ? (sellVal - dBuy) * load : 0;
            const mods = getActiveModifiers(uiState);
            let finalProfit = baseProfit > 0 ? Math.floor(baseProfit * mods.totalMultiplier) : baseProfit;
            const divisor = (uiState.commerceType === "Barter") ? 34 : 17;
            const score = Math.max(0, Math.floor(((sellVal - (item.buy || 0)) * load) / divisor));
            return { profit: finalProfit, score: score, load: load };
        }

        function getAvailableMounts(uiState) {
            const mounts = ['Back Pack'];
            Object.keys(transportOwnership).forEach(key => {
                if (transportOwnership[key]) {
                    if (key === 'Air Ship' && uiState.commerceType !== 'Group') return;
                    mounts.push(key);
                }
            });
            return mounts;
        }

        function calculateBestRouteForVector(originCity, targetCities, originItems, uiState, forcedMount = null) {
            let best = null, maxP = -1;
            const mods = getActiveModifiers(uiState);
            const mountsToCheck = forcedMount ? [forcedMount] : getAvailableMounts(uiState);

            targetCities.forEach(targetCity => {
                mountsToCheck.forEach(mKey => {
                    const stats = getModifiedStats(mKey, uiState);
                    let remWeight = stats.weight, remSlots = stats.slots, totalP = 0, itemsToBuy = [];
                    const potential = originItems.map(item => {
                        const basePrice = publicBasePrices[item.name] || item.buy;
                        const dBuy = getDiscountedBuyPrice(basePrice, uiState);
                        const unitP = (getPrice(item.name, targetCity) - dBuy) * (1 + (getPrice(item.name, targetCity) > dBuy ? (mods.totalMultiplier - 1) : 0));
                        return { ...item, unitP, eff: unitP / Math.max(1, item.weight) };
                    }).filter(i => i.unitP > 0).sort((a, b) => b.eff - a.eff);

                    potential.forEach(item => {
                        const stock = getStock(item.name);
                        let qty = Math.min(Math.floor(remWeight / item.weight), remSlots * item.max, item.limit, stock);
                        if (qty <= 0) return;
                        let slotsNeeded = Math.ceil(qty / item.max);
                        const stackProfit = Math.floor(qty * item.unitP);
                        itemsToBuy.push({ n: item.name, q: qty, p: stackProfit, img: item.img, s: slotsNeeded, maxPerSlot: item.max });
                        remWeight -= (qty * item.weight); remSlots -= slotsNeeded; totalP += stackProfit;
                    });
                    if (totalP > maxP) { maxP = totalP; best = { origin: originCity, dest: targetCity, mount: mKey, items: itemsToBuy, profit: totalP, maxSlots: stats.slots }; }
                });
            });
            return { best, maxP };
        }

        function runManifests(uiState) {
            const origin = document.getElementById('city-select').value;
            const targetPool = (uiState.commerceType === "Barter" ? citiesByType["Normal"] : citiesByType[uiState.commerceType]);
            const targets = targetPool.filter(c => c !== origin);
            const originItems = (marketData[uiState.commerceType] && marketData[uiState.commerceType][origin]) || [];
            
            const localResult = calculateBestRouteForVector(origin, targets, originItems, uiState, null);
            renderManifest(localResult.best, 'manifest-box', 'manifest-list', 'manifest-total');

            let globalBest = null, globalMax = -1;
            (citiesByType[uiState.commerceType] || []).forEach(org => {
                const orgItems = (marketData[uiState.commerceType] && marketData[uiState.commerceType][org]) || [];
                const res = calculateBestRouteForVector(org, targetPool.filter(c => c !== org), orgItems, uiState, null);
                if (res.maxP > globalMax) { globalMax = res.maxP; globalBest = res.best; }
            });
            const anchor = document.getElementById('global-manifest-anchor');
            if (!globalBest || globalMax <= 0) anchor.innerHTML = ''; else renderGlobalManifest(globalBest, anchor);
        }

        function renderManifest(trip, boxId, listId, totalId) {
            const box = document.getElementById(boxId), list = document.getElementById(listId), total = document.getElementById(totalId);
            if (!trip || trip.profit <= 0) {
                box.style.display = 'block';
                list.innerHTML = `<div style="color:var(--text-dim); font-size:10px; padding:10px; text-align:center;">NO ROUTES FOUND</div>`;
                total.textContent = `PROFIT: 0`;
                return;
            }
            box.style.display = 'block';
            document.getElementById('manifest-dest').innerText = trip.dest;
            
            let slotHtml = '';
            let filled = 0;
            trip.items.forEach(item => {
                let rem = item.q;
                for (let i = 0; i < item.s; i++) {
                    const sqty = Math.min(item.maxPerSlot, rem); rem -= sqty;
                    slotHtml += `<div class="slot filled" style="background-image: url('${getImagePath(item.img)}');"><span class="slot-badge">${sqty}</span></div>`;
                    filled++;
                }
            });
            for (let i = filled; i < trip.maxSlots; i++) slotHtml += `<div class="slot empty"></div>`;
            list.innerHTML = slotHtml;
            total.textContent = `+${trip.profit.toLocaleString()}`;
        }

        function renderGlobalManifest(trip, container) {
            let slotHtml = '<div class="manifest-slots">';
            trip.items.forEach(item => {
                let rem = item.q;
                for (let i = 0; i < item.s; i++) {
                    const sqty = Math.min(item.maxPerSlot, rem); rem -= sqty;
                    slotHtml += `<div class="slot filled" style="background-image: url('${getImagePath(item.img)}');"><span class="slot-badge">${sqty}</span></div>`;
                }
            });
            slotHtml += '</div>';

            container.innerHTML = `
                <div class="manifest-container" style="border-color:var(--warning);">
                    <div class="manifest-header" style="color:var(--warning);">
                        <span>Global Best</span>
                        <span style="color:#fff;">${trip.origin} → ${trip.dest}</span>
                    </div>
                    ${slotHtml}
                    <div class="manifest-total">+${trip.profit.toLocaleString()}</div>
                </div>`;
        }

        function refreshUI() {
            if (document.activeElement && (
                document.activeElement.classList.contains('price-input') || 
                document.activeElement.classList.contains('qty-input') ||
                document.activeElement.id === 'base-price-input'
            )) return;
            
            const uiState = getUIState(); 
            updateMarketItems(uiState); 
            showPrices(uiState); 
            updatePreview(uiState); 
            updateRecommendationAndStats(); 
            updateTownIcon(); 
            runManifests(uiState);
            updateTransportDropdown(); 

            const wCheck = document.getElementById('william-check');
            const wBox = document.getElementById('william-like-box');
            if(wCheck && wBox) wBox.style.display = wCheck.checked ? 'flex' : 'none';
        }

        function updatePreview(uiState) {
            if (!currentItem) return;
            document.getElementById('center-item-icon').style.backgroundImage = `url('${getImagePath(currentItem.img)}')`;
            document.getElementById('center-item-title').textContent = currentItem.name;
            
            const currentBase = publicBasePrices[currentItem.name] || currentItem.buy;
            document.getElementById('base-price-input').value = currentBase;
            document.getElementById('base-price-container').style.display = 'flex';

            document.getElementById('max-inventory-display').textContent = `Weight: ${currentItem.weight} | Stack: ${currentItem.max}`;
        }

        function updateTownIcon() {
            const avatar = document.getElementById('origin-town-icon');
            const city = document.getElementById('city-select').value;
            if (avatar && townIcons[city]) avatar.style.backgroundImage = `url('${getImagePath(townIcons[city])}')`;
        }

        function updateMarketItems(uiState) {
            const container = document.getElementById('market-items-container');
            container.innerHTML = '';
            const type = uiState.commerceType;
            const city = document.getElementById('city-select').value;
            if(!city) return; 

            const searchTerm = document.getElementById('global-search').value.toLowerCase().trim();
            document.getElementById('clear-search').style.display = searchTerm ? 'block' : 'none';

            let items = [];
            if (searchTerm) {
                (citiesByType[type] || []).forEach(town => {
                    ((marketData[type] && marketData[type][town]) || []).forEach(item => {
                        if (item.name.toLowerCase().includes(searchTerm)) items.push({ ...item, _townName: town });
                    });
                });
            } else { items = (marketData[type] && marketData[type][city]) || []; }

            if (items.length > 0 && (!currentItem || !items.find(i => i.name === currentItem.name))) { currentItem = items[0]; updatePreview(uiState); }

            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const isSelected = currentItem && currentItem.name === item.name;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item' + (isSelected ? ' selected-item' : '');
                const cStock = getStock(item.name);
                itemDiv.innerHTML = `<div class="item-list-icon-box" style="background-image: url('${getImagePath(item.img)}')"></div><div class="item-list-content"><div><span class="item-name">${item.name}</span>${item._townName ? `<span class="item-town-badge">📍 ${item._townName}</span>` : ''}</div><div class="stock-input-row"><span style="font-size:9px; color:#aaa;">STOCK</span><input type="number" class="qty-input input-dark" value="${cStock || ''}" placeholder="0" onfocus="this.select()" onclick="event.stopPropagation()" onchange="updateStock('${item.name.replace(/'/g, "\\'")}', this.value)"></div></div>`;
                itemDiv.addEventListener('click', () => { 
                    currentItem = item; 
                    refreshUI(); 
                    if (window.innerWidth <= 1000) closeSidebars(); // Auto-close drawer on mobile
                });
                fragment.appendChild(itemDiv);
            });
            container.appendChild(fragment);
        }

        function showPrices(uiState) {
            const list = document.getElementById('profit-list');
            if (document.activeElement && document.activeElement.classList.contains('price-input')) return;
            list.innerHTML = '';
            if (!currentItem) return;
            const type = uiState.commerceType;
            const origin = currentItem._townName || document.getElementById('city-select').value;
            
            const fragment = document.createDocumentFragment();
            (type === "Barter" ? citiesByType["Normal"] : citiesByType[type]).filter(c => c !== origin).forEach(city => {
                const sellVal = getPrice(currentItem.name, city);
                const res = calculateItemProfit(currentItem, city, uiState, sellVal);
                const row = document.createElement('div');
                row.className = 'market-row';
                row.innerHTML = `<div class="market-left"><b>${city}</b></div><div class="col-price"><input type="number" class="price-input input-dark" value="${sellVal || ''}" onfocus="this.select()" oninput="updatePrice('${city}', this.value)"></div><div class="market-profit-col"><span class="profit-val ${res.profit < 0 ? 'negative' : ''}">${res.profit.toLocaleString()}</span></div><div class="market-score-col"><span class="score-val ${res.score < 0 ? 'negative' : ''}">${res.score.toLocaleString()}</span></div>`;
                fragment.appendChild(row);
            });
            list.appendChild(fragment);
        }

        function updateTransportDropdown() {
            const dropdown = document.getElementById('transport-dropdown');
            const current = dropdown.value || "Back Pack";
            const tempState = { commerceType: document.getElementById('commerce-type-select').value };
            const mounts = ['Back Pack'];
            Object.keys(transportOwnership).forEach(key => {
                if (transportOwnership[key]) {
                    if (key === 'Air Ship' && tempState.commerceType !== 'Group') return;
                    mounts.push(key);
                }
            });
            dropdown.innerHTML = mounts.map(m => `<option value="${m}">${m}</option>`).join('');
            if (mounts.includes(current)) dropdown.value = current; else dropdown.value = "Back Pack";
        }

        function updateRecommendationAndStats() { /* handled in refreshUI */ }

        // --- FIREBASE WRAPPERS ---
        function updatePrice(city, val) {
            if (!currentItem) return;
            const sellVal = parseInt(val, 10) || 0;
            const priceKey = `${currentItem.name}_${city}`.replace(/[.#$[\]]/g, "_");
            publicPrices[priceKey] = sellVal;
            skipRender = true;
            if(rtdb) { try { rtdb.ref(`public_commerce/prices/${priceKey}`).set(sellVal); } catch(e){} }
            const activeInput = document.activeElement;
            if (activeInput && activeInput.classList.contains('price-input')) {
                const row = activeInput.closest('.market-row');
                if (row) {
                    const uiState = getUIState();
                    const result = calculateItemProfit(currentItem, city, uiState, sellVal);
                    const profitEl = row.querySelector('.market-profit-col span');
                    const scoreEl = row.querySelector('.market-score-col span');
                    if (profitEl) { profitEl.textContent = result.profit.toLocaleString(); profitEl.className = `profit-val ${result.profit < 0 ? 'negative' : ''}`; }
                    if (scoreEl) { scoreEl.textContent = result.score.toLocaleString(); }
                }
            }
            runManifests(getUIState());
        }

        function updateStock(itemName, quantity) {
            const qty = parseInt(quantity) || 0;
            publicStocks[itemName] = qty;
            skipRender = true;
            if(rtdb) { try { rtdb.ref(`public_commerce/stocks/${itemName}`).set(qty); } catch(e){} }
            runManifests(getUIState());
        }

        function updateBasePrice(val) {
            if (!currentItem) return;
            const price = parseInt(val) || 0;
            publicBasePrices[currentItem.name] = price;
            skipRender = true;
            if(rtdb) { try { rtdb.ref(`public_commerce/base_prices/${currentItem.name}`).set(price); } catch(e){} }
            const uiState = getUIState();
            showPrices(uiState);
            runManifests(uiState);
        }

        function savePrefs() {
            const prefs = getUIState();
            prefs.transports = transportOwnership;
            prefs.type = prefs.commerceType; delete prefs.commerceType;
            prefs.city = document.getElementById('city-select').value;
            prefs.mount = prefs.transport; delete prefs.transport;

            localStorage.setItem('mabi_prefs', JSON.stringify(prefs));
            localStorage.setItem('mabi_transports', JSON.stringify(transportOwnership));
            if (currentUser && rtdb) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => { try { rtdb.ref(`users/${currentUser.uid}/settings`).update(prefs); } catch(e){} }, 1000);
            }
        }

        function saveTownRanks() {
            localStorage.setItem('mabi_ranks', JSON.stringify(townRanks));
            if (currentUser && rtdb) { try { rtdb.ref(`users/${currentUser.uid}/town_ranks`).set(townRanks); } catch(e){} }
        }

        function updateCityContext() {
            const city = document.getElementById('city-select').value;
            if(!city) return;
            document.getElementById('merchant-rating-select').value = townRanks[city] || "1";
            refreshUI();
        }

        // --- MOBILE NAV LOGIC ---
        function toggleSidebar(side) {
            const left = document.getElementById('left-panel');
            const right = document.getElementById('right-panel');
            const backdrop = document.getElementById('mobile-backdrop');
            
            if (side === 'left') {
                const isActive = left.classList.contains('active');
                closeSidebars();
                if (!isActive) { left.classList.add('active'); backdrop.classList.add('active'); }
            } else if (side === 'right') {
                const isActive = right.classList.contains('active');
                closeSidebars();
                if (!isActive) { right.classList.add('active'); backdrop.classList.add('active'); }
            }
        }

        function closeSidebars() {
            document.getElementById('left-panel').classList.remove('active');
            document.getElementById('right-panel').classList.remove('active');
            document.getElementById('mobile-backdrop').classList.remove('active');
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const saved = JSON.parse(localStorage.getItem('mabi_prefs')) || {};
            try { townRanks = JSON.parse(localStorage.getItem('mabi_ranks')) || {}; } catch(e){ townRanks = {}; }
            
            // 1. Setup Dropdowns
            const mSelect = document.getElementById('mastery-rank');
            mSelect.innerHTML = Object.keys(masteryRanks).map(r => `<option value="${r}">Rank ${r} (+${Math.round(masteryRanks[r]*100)}%)</option>`).join('');
            mSelect.value = "F";
            const lSelect = document.getElementById('letter-select');
            lSelect.innerHTML = ["None", "Ogre", "Goblin", "Imp", "Irusan's (Special)"].map(n => `<option value="${n}">${n}</option>`).join('');
            lSelect.value = "None";

            // 2. Setup Toggles
            document.querySelectorAll('.transport-toggle').forEach(toggle => {
                toggle.onchange = (e) => { transportOwnership[toggle.dataset.mount] = e.target.checked; savePrefs(); updateTransportDropdown(); refreshUI(); };
            });

            // 3. UI Logic Listeners
            const typeSelect = document.getElementById('commerce-type-select');
            const citySelect = document.getElementById('city-select');
            typeSelect.onchange = (e) => {
                const valid = citiesByType[e.target.value];
                citySelect.innerHTML = valid.map(c => `<option value="${c}">${c}</option>`).join('');
                if(valid.length > 0) citySelect.value = valid[0];
                updateCityContext(); updateTransportDropdown();
            };
            citySelect.onchange = () => { updateCityContext(); savePrefs(); };
            document.getElementById('merchant-rating-select').onchange = function() { townRanks[citySelect.value] = this.value; saveTownRanks(); refreshUI(); };
            
            ['transport-dropdown', 'trader-qty', 'trustworthy-qty', 'mastery-rank', 'letter-select', 'fine-letter-check', 'gm-check', 'william-likeability'].forEach(id => {
                const el = document.getElementById(id);
                el.onchange = () => { refreshUI(); savePrefs(); };
                if (el.tagName === 'INPUT') el.oninput = () => { refreshUI(); savePrefs(); };
            });
            document.getElementById('william-check').onchange = function() { if (this.checked) document.getElementById('alpaca-check').checked = false; refreshUI(); savePrefs(); };
            document.getElementById('alpaca-check').onchange = function() { if (this.checked) document.getElementById('william-check').checked = false; refreshUI(); savePrefs(); };
            document.getElementById('global-search').oninput = refreshUI;
            document.getElementById('clear-search').onclick = () => { document.getElementById('global-search').value = ''; refreshUI(); };

            // 4. RESTORE PREFS & INITIAL RENDER
            if (saved.type && citiesByType[saved.type]) typeSelect.value = saved.type; else typeSelect.value = "Normal";
            const validCities = citiesByType[typeSelect.value];
            citySelect.innerHTML = validCities.map(c => `<option value="${c}">${c}</option>`).join('');
            if (saved.city && validCities.includes(saved.city)) citySelect.value = saved.city; else if (validCities.length > 0) citySelect.value = validCities[0];

            if (saved.mount) document.getElementById('transport-dropdown').value = saved.mount;
            if (saved.trader) document.getElementById('trader-qty').value = saved.trader;
            if (saved.trust) document.getElementById('trustworthy-qty').value = saved.trust;
            if (saved.mastery) document.getElementById('mastery-rank').value = saved.mastery;
            if (saved.letter) document.getElementById('letter-select').value = saved.letter;
            document.getElementById('fine-letter-check').checked = !!saved.fineLetter;
            document.getElementById('gm-check').checked = !!saved.gm;
            document.getElementById('william-check').checked = !!saved.william;
            if(saved.williamLike) document.getElementById('william-likeability').value = saved.williamLike;
            document.getElementById('alpaca-check').checked = !!saved.alpaca;
            if(saved.transports) {
                transportOwnership = saved.transports;
                Object.keys(transportOwnership).forEach(key => {
                    const toggle = document.querySelector(`.transport-toggle[data-mount="${key}"]`);
                    if(toggle) toggle.checked = transportOwnership[key];
                });
            }
            
            updateCityContext();
            updateTransportDropdown();
            refreshUI();

            // 5. Firebase Init
            function initApp() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyC7A3Rzi-VddhqZiFGjHjjqBwCdX1ks6yM",
                        authDomain: "mabinogi-tracker.firebaseapp.com",
                        databaseURL: "https://mabinogi-tracker-default-rtdb.firebaseio.com",
                        projectId: "mabinogi-tracker",
                        storageBucket: "mabinogi-tracker.firebasestorage.app",
                        messagingSenderId: "267690802644",
                        appId: "1:267690802644:web:fccdd005d5c8990504ea41",
                        measurementId: "G-VBDBKQ3M1B"
                    };
                    firebase.initializeApp(firebaseConfig);
                    rtdb = firebase.database();
                    auth = firebase.auth();
                    
                    rtdb.ref('public_commerce/prices').on('value', (s) => { 
                        if (skipRender) { skipRender = false; return; }
                        publicPrices = s.val() || {}; refreshUI(); 
                    });
                    rtdb.ref('public_commerce/stocks').on('value', (s) => { 
                        if (skipRender) { skipRender = false; return; }
                        publicStocks = s.val() || {}; refreshUI(); 
                    });
                    rtdb.ref('public_commerce/base_prices').on('value', (s) => { 
                        if (skipRender) { skipRender = false; return; }
                        publicBasePrices = s.val() || {}; refreshUI(); 
                    });

                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) auth.signInWithCustomToken(__initial_auth_token);

                    auth.onAuthStateChanged((user) => {
                        currentUser = user;
                        if (user) {
                            rtdb.ref(`users/${user.uid}/settings`).on('value', (s) => { 
                                if(s.val()) { 
                                    const d=s.val(); 
                                    if(d.transports) {
                                        transportOwnership=d.transports; 
                                        Object.keys(transportOwnership).forEach(key => {
                                            const toggle = document.querySelector(`.transport-toggle[data-mount="${key}"]`);
                                            if(toggle) toggle.checked = transportOwnership[key];
                                        });
                                    }
                                    refreshUI(); 
                                } 
                            });
                            rtdb.ref(`users/${user.uid}/town_ranks`).on('value', (s) => { if(s.val()) { townRanks = s.val(); updateCityContext(); } });
                        }
                    });
                } catch(e) { console.log("Running in offline mode"); }
            }

            initApp();
        });
    </script>
</body>
</html>
