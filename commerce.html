<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Commerce Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            /* V2.7 Theme from Hub */
            --bg: #09090b;
            --sidebar-bg: #121214;
            --card-bg: #18181b;
            --accent: #00ff88;
            --accent-dim: rgba(0, 255, 136, 0.1);
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-dim: #a1a1aa;
            --warning: #facc15;
            --danger: #ef4444;
            --slot-size: 50px;
        }

        /* --- Global & Reset --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            font-size: 13px;
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- Layout Containers --- */
        .interface-container {
            width: 100%; height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }
        
        .header-bar { 
            background: var(--sidebar-bg); border-bottom: 1px solid var(--border); 
            padding: 10px 20px; flex-shrink: 0;
        }

        .content-grid {
            display: grid; grid-template-columns: 340px 1fr 340px; 
            flex-grow: 1; overflow: hidden; position: relative;
        }
        
        .panel {
            background: var(--bg); overflow-y: auto; display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .panel:last-child { border-right: none; }
        
        .center-panel { background: #0c0c0e; }

        /* --- Header Elements --- */
        .title-section {
            display: flex; justify-content: space-between; align-items: center; max-width: 1500px; margin: 0 auto; width: 100%;
        }
        .main-title {
            font-size: 16px; font-weight: 700; color: #fff; letter-spacing: 0.5px;
        }
        .hub-btn {
            color: var(--text-dim); text-decoration: none; font-weight: 600; font-size: 12px;
            padding: 6px 12px; border-radius: 6px; transition: 0.2s; border: 1px solid transparent;
        }
        .hub-btn:hover { color: #fff; background: var(--border); }

        /* --- Form Elements --- */
        .panel-label {
            font-size: 11px; font-weight: 600; color: var(--text-dim);
            margin-bottom: 8px; display: block; text-transform: uppercase;
        }
        
        .input-dark {
            background: var(--card-bg); border: 1px solid var(--border); color: #fff;
            font-family: 'Inter', sans-serif; font-size: 13px; padding: 8px; border-radius: 6px;
            width: 100%; transition: border-color 0.2s;
        }
        .input-dark:focus { border-color: var(--accent); }
        
        /* --- Transparent Square UI --- */
        .tab-picker { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 6px; margin-bottom: 15px; }
        .picker-btn { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 6px 4px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: 0.15s; }
        .picker-btn.active { background: var(--accent-dim); border-color: var(--accent); }
        .picker-icon { 
            width: 32px; height: 32px; background-size: contain; background-repeat: no-repeat; 
            background-position: center; border: 1px solid var(--border); border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.03);
        }
        .picker-label { font-size: 9px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; text-align: center; }

        /* --- Drawer UI --- */
        .drawer-wrap { border-bottom: 1px solid var(--border); }
        summary { 
            list-style: none; cursor: pointer; padding: 12px 20px; 
            font-size: 11px; font-weight: 700; color: var(--text-dim); 
            text-transform: uppercase; display: flex; align-items: center; gap: 10px;
            user-select: none;
        }
        summary::before { content: '▶'; font-size: 8px; transition: 0.2s; }
        details[open] summary::before { transform: rotate(90deg); color: var(--accent); }
        
        .horizontal-drawer {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 0 20px 15px 20px;
            -webkit-overflow-scrolling: touch;
        }
        .horizontal-drawer .picker-btn {
            flex: 0 0 75px;
            min-width: 75px;
        }

        /* --- Left Panel Items --- */
        .item-list { flex-grow: 1; overflow-y: auto; }
        
        .inventory-item {
            display: flex; gap: 12px; padding: 10px 15px;
            border-bottom: 1px solid var(--border); cursor: pointer;
            align-items: center; transition: 0.15s;
        }
        .inventory-item:hover { background: var(--card-bg); }
        .selected-item { background: var(--accent-dim); border-left: 3px solid var(--accent); }
        
        .item-icon-box {
            width: 48px; height: 48px; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 4px; background-size: contain; background-repeat: no-repeat; 
            background-position: center; flex-shrink: 0; background-color: rgba(255, 255, 255, 0.03);
        }
        .item-name { font-weight: 600; font-size: 13px; color: #fff; }
        .item-list-content { flex-grow: 1; }
        .stock-input-row { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
        
        /* --- Center Panel --- */
        .item-header {
            padding: 30px; border-bottom: 1px solid var(--border); display: flex;
            gap: 20px; align-items: center; background: var(--card-bg); flex-shrink: 0;
        }
        .big-icon {
            width: 80px; height: 80px; background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; background-size: contain; background-repeat: no-repeat; background-position: center;
            background-color: rgba(255, 255, 255, 0.03);
        }
        .item-title-large { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        
        .market-row {
            display: grid; grid-template-columns: 1.5fr 1fr 1fr 0.8fr;
            padding: 12px 20px; border-bottom: 1px solid var(--border);
            align-items: center; gap: 15px; font-size: 13px;
        }
        .market-row.head { background: var(--card-bg); font-weight: 600; color: var(--text-dim); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 10; }
        
        .profit-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; text-align: right; color: var(--accent); }
        .profit-val.negative { color: var(--danger); }
        .score-val { font-family: 'JetBrains Mono', monospace; text-align: right; color: var(--text-dim); }

        /* --- Right Panel Toggles --- */
        .toggle-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0; cursor: pointer;
        }
        .toggle-label { font-size: 13px; color: var(--text-main); }
        
        .toggle-switch {
            width: 36px; height: 20px; background: var(--border); border-radius: 99px;
            position: relative; transition: 0.2s;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px;
            background: #fff; border-radius: 50%; transition: 0.2s;
        }
        input:checked + .toggle-switch { background: var(--accent); }
        input:checked + .toggle-switch::after { transform: translateX(16px); }
        .toggle-input { display: none; }

        /* --- Manifest Box --- */
        .manifest-container {
            margin: 20px; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 8px; padding: 15px;
        }
        .manifest-header {
            font-size: 11px; font-weight: 700; color: var(--accent); text-transform: uppercase;
            margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between;
        }
        .manifest-slots { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; }
        .slot {
            width: 42px; height: 42px; background: var(--bg); border: 1px solid var(--border);
            border-radius: 4px; background-size: contain; background-repeat: no-repeat;
            background-position: center; position: relative; background-color: rgba(255, 255, 255, 0.03);
        }
        .slot.filled { border-color: var(--accent); background-color: var(--accent-dim); }
        .slot-badge {
            position: absolute; bottom: -2px; right: -2px; background: var(--accent); color: #000;
            font-size: 9px; font-weight: 700; padding: 0 3px; border-radius: 2px;
        }
        .manifest-total { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #fff; text-align: right; }

        /* --- MOBILE STYLES --- */
        .mobile-nav { display: none; }
        .mobile-backdrop { display: none; }

        @media (max-width: 1000px) {
            .content-grid { display: block; height: calc(100vh - 50px); }
            .header-bar { display: none; }
            
            .mobile-nav {
                display: flex; justify-content: space-between; align-items: center;
                padding: 10px 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border);
                height: 50px; z-index: 50; flex-shrink: 0;
            }
            .nav-trigger {
                background: transparent; border: 1px solid var(--border); color: var(--text-main);
                padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
            }
            
            .left-panel, .right-panel {
                position: fixed; top: 0; bottom: 0; width: 320px; max-width: 85%;
                z-index: 2000 !important; box-shadow: 0 0 50px rgba(0,0,0,0.8);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .left-panel { left: 0; transform: translateX(-100%); border-right: 1px solid var(--border); }
            .left-panel.active { transform: translateX(0); }
            
            .right-panel { right: 0; transform: translateX(100%); border-left: 1px solid var(--border); max-width: 85%; }
            .right-panel.active { transform: translateX(0); }
            
            .mobile-backdrop {
                display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
                z-index: 1500; opacity: 0; pointer-events: none; transition: opacity 0.3s;
                backdrop-filter: blur(4px);
            }
            .mobile-backdrop.active { opacity: 1; pointer-events: all; }
            
            .center-panel { height: 100%; width: 100%; border: none; z-index: 1 !important; position: relative; }
        }
    </style>
</head>
<body>

    <div class="mobile-nav">
        <button class="nav-trigger" onclick="toggleSidebar('left')">☰ Catalog</button>
        <span style="font-weight:700; color:#fff;">Commerce</span>
        <button class="nav-trigger" onclick="toggleSidebar('right')">Config</button>
    </div>

    <div class="mobile-backdrop" id="mobile-backdrop" onclick="closeSidebars()"></div>

    <div class="interface-container">
        <div class="header-bar">
            <div class="title-section">
                <div style="display:flex; align-items:center;">
                    <span class="main-title">COMMERCE TRACKER</span>
                </div>
                <div style="display:flex; gap:15px; align-items:center;">
                    <!-- Updated User Display: No Uppercase Transform -->
                    <span id="user-display" style="font-size:11px; color:var(--accent);">GUEST</span>
                    <a href="index.html" class="hub-btn">Back to Hub</a>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <div class="panel left-panel" id="left-panel">
                <!-- COMMERCE MODE DRAWER -->
                <details class="drawer-wrap">
                    <summary>Commerce Mode</summary>
                    <div id="commerce-type-tabs" class="horizontal-drawer"></div>
                </details>

                <!-- TRANSPORT DRAWER (UPDATED: No Horizontal Scroll) -->
                <details class="drawer-wrap">
                    <summary>Transport Selection</summary>
                    <div style="padding: 0 20px 15px 20px;">
                        <div id="transport-tabs" class="tab-picker" style="margin-bottom: 0;"></div>
                    </div>
                </details>

                <!-- TRADING POST DRAWER -->
                <details class="drawer-wrap" open>
                    <summary>
                        <span>Trading Post</span>
                        <!-- FIXED: stopPropagation on click AND mousedown to prevent drawer toggle -->
                        <div style="margin-left:auto; display:flex; align-items:center; gap:8px;" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">
                            <span style="font-size:10px; color:var(--text-dim);">RATING</span>
                            <input type="number" id="merchant-rating-input" class="input-dark" style="width:45px; padding:2px; height:24px; text-align:center;" min="1" max="9" value="1" oninput="validateRating(this)" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">
                        </div>
                    </summary>
                    <div style="padding: 0 20px 15px 20px;">
                        <div id="city-tabs" class="tab-picker" style="margin-bottom: 0;"></div>
                    </div>
                </details>
                
                <div id="market-items-container" class="item-list"></div>
            </div>

            <div class="panel center-panel">
                <div class="item-header">
                    <div class="big-icon" id="center-item-icon"></div>
                    <div class="item-title-box">
                        <div class="item-title-large" id="center-item-title">Select Item</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1.5fr; align-items: center; width: 100%; margin-top: 8px;">
                            <div class="item-inventory" id="weight-display" style="text-align: left;">Weight: -</div>
                            <div class="item-inventory" id="stack-display" style="text-align: center;">Stack: -</div>
                            <div id="base-price-container" style="display:none; justify-content: flex-end; align-items: center; gap: 8px;">
                                <span style="font-size: 10px; color: var(--text-dim); font-weight: 600;">BASE</span>
                                <input type="number" id="base-price-input" class="input-dark" style="width: 70px; text-align: right; padding: 4px;" onchange="updateBasePrice(this.value)" onfocus="this.select()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="market-list-container">
                    <div class="market-row head">
                        <div>Destination</div>
                        <div style="text-align:right;">Sell Price</div>
                        <div style="text-align:right;">Profit</div>
                        <div style="text-align:right;">Score</div>
                    </div>
                    <div id="profit-list"></div>
                </div>
            </div>

            <div class="panel right-panel" id="right-panel">
                <!-- RIGHT SIDE DRAWER 1: PROFIT MODIFIERS -->
                <details class="drawer-wrap" open>
                    <summary>Profit Modifiers</summary>
                    <div style="padding: 0 20px 15px 20px;">
                        <label class="panel-label">Mastery Rank</label>
                        <select id="mastery-rank" class="input-dark" style="margin-bottom:12px;"></select>
                        
                        <label class="panel-label">Guarantee Letters</label>
                        <div style="display:flex; gap:8px;">
                            <select id="letter-select" class="input-dark" style="flex:1;"></select>
                            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                                <input type="checkbox" id="fine-letter-check"> <span style="font-size:11px; color:#aaa;">Fine</span>
                            </label>
                        </div>
                    </div>
                </details>

                <!-- RIGHT SIDE DRAWER 2: PARTNERS & GEAR -->
                <details class="drawer-wrap" open>
                    <summary>Support & Gear</summary>
                    <div style="padding: 0 20px 15px 20px;">
                        <div class="toggle-row">
                            <span class="toggle-label">Grandmaster Merchant</span>
                            <label><input type="checkbox" id="gm-check" style="display:none;"><div class="toggle-switch"></div></label>
                        </div>

                        <div class="toggle-row">
                            <span class="toggle-label">Alpaca Support</span>
                            <label><input type="checkbox" id="alpaca-check" style="display:none;"><div class="toggle-switch"></div></label>
                        </div>

                        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:5px;">
                            <div class="toggle-row" style="flex:1;">
                                <span class="toggle-label">Partner: William</span>
                                <label style="margin-left:10px;"><input type="checkbox" id="william-check" style="display:none;"><div class="toggle-switch"></div></label>
                            </div>
                            <div id="william-like-box" style="display:none; align-items:center; gap:5px;">
                                <span style="font-size:10px; color:#666;">Like</span>
                                <input type="number" id="william-likeability" class="input-dark" style="width:50px; padding:4px; text-align:center;" value="247">
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span class="toggle-label">Trader Enchant Qty</span>
                                <input type="number" id="trader-qty" class="input-dark" style="width:50px; text-align:center;" min="0" max="2" value="0">
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="toggle-label">Trustworthy Enchant Qty</span>
                                <input type="number" id="trustworthy-qty" class="input-dark" style="width:50px; text-align:center;" min="0" max="2" value="0">
                            </div>
                        </div>
                    </div>
                </details>

                <!-- RIGHT SIDE DRAWER 3: VEHICLE FLEET -->
                <details class="drawer-wrap">
                    <summary>Vehicle Fleet</summary>
                    <div style="padding: 0 20px 15px 20px; display:grid; grid-template-columns: 1fr 1fr; gap: 0 15px;">
                        <div class="toggle-row"><span class="toggle-label">Hand Cart</span><label><input type="checkbox" id="handcart-check" class="transport-toggle" data-mount="Hand Cart" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Wagon</span><label><input type="checkbox" id="wagon-check" class="transport-toggle" data-mount="Wagon" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Elephant</span><label><input type="checkbox" id="elephant-check" class="transport-toggle" data-mount="Elephant" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Husky</span><label><input type="checkbox" id="husky-check" class="transport-toggle" data-mount="Husky" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Camel</span><label><input type="checkbox" id="camel-check" class="transport-toggle" data-mount="Camel" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Skiff</span><label><input type="checkbox" id="skiff-check" class="transport-toggle" data-mount="Skiff" style="display:none;"><div class="toggle-switch"></div></label></div>
                        <div class="toggle-row"><span class="toggle-label">Air Ship</span><label><input type="checkbox" id="airship-check" class="transport-toggle" data-mount="Air Ship" style="display:none;"><div class="toggle-switch"></div></label></div>
                    </div>
                </details>

                <!-- OPTIMAL ROUTE (Remaining focused) -->
                <div class="manifest-container" id="manifest-box" style="display:none;">
                    <div class="manifest-header">
                        <span>Optimal Route</span>
                        <span id="manifest-dest" style="color:#fff;">-</span>
                    </div>
                    <div id="manifest-list" class="manifest-slots"></div>
                    <div id="manifest-total" class="manifest-total"></div>
                </div>

                <div id="global-manifest-anchor"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & DATA ---
        const townIcons={"Tir Chonaill":"tradeposts/Commerce_Tir_Chonaill_Icon.png","Dunbarton":"tradeposts/Commerce_Dunbarton_Icon.png","Bangor":"tradeposts/Commerce_Bangor_Icon.png","Emain Macha":"tradeposts/Commerce_Emain_Macha_Icon.png","Taillteann":"tradeposts/Commerce_Taillteann_Icon.png","Tara":"tradeposts/Commerce_Tara_Icon.png","Cobh":"tradeposts/Commerce_Port_Cobh_Icon.png","Belvast":"tradeposts/Commerce_Commonwealth_of_Belvast_Icon.png","Qilla":"tradeposts/Commerce_Qilla_Icon.png","Cor":"tradeposts/Commerce_Cor_Icon.png","Vales":"tradeposts/Commerce_Vales_Icon.png","Filia":"tradeposts/Commerce_Filia_Icon.png","Karu Forest":"tradeposts/Commerce_Karu_Forest_Icon.png","Oasis":"tradeposts/Commerce_Oasis_Icon.png","Lake Calida":"tradeposts/Commerce_Calida_Icon.png","Pera Volcano":"tradeposts/Commerce_Pera_Icon.png","Scathach Beach":"tradeposts/Commerce_Beach_of_Scathach_Icon.png"};
        
        const transportIcons={
            "Back Pack":"images/transports/Backpack_Icon.png",
            "Hand Cart":"images/transports/Handcart_Icon.png",
            "Wagon":"images/transports/Wagon_Icon.png",
            "Elephant":"images/transports/Elephant_Icon.png",
            "Husky":"images/transports/Dog_Sled_Icon.png",
            "Camel":"images/transports/Camel_Icon.png",
            "Skiff":"images/transports/Traders_Skiff_Icon.png",
            "Air Ship":"images/transports/Airship_Icon.png"
        };
        
        const transportData={
            "Back Pack":{slots:4,weight:400},
            "Hand Cart":{slots:6,weight:800},
            "Wagon":{slots:8,weight:900},
            "Elephant":{slots:7,weight:1700},
            "Husky":{slots:11,weight:700},
            "Camel":{slots:7,weight:1400},
            "Skiff":{slots:8,weight:1200},
            "Air Ship":{slots:18,weight:2500}
        };

        const citiesByType={"Normal":["Tir Chonaill","Dunbarton","Bangor","Emain Macha","Taillteann","Tara","Cobh","Belvast","Qilla","Cor","Vales","Filia"],"Barter":["Karu Forest","Oasis","Lake Calida","Pera Volcano","Scathach Beach"],"Group":["Qilla","Filia","Cor","Vales"]};
        const masteryRanks={"1":0.15,"2":0.14,"3":0.13,"4":0.12,"5":0.11,"6":0.10,"7":0.09,"8":0.08,"9":0.07,"A":0.06,"B":0.05,"C":0.04,"D":0.03,"E":0.02,"F":0.01};
        const guaranteeLetters={"None":{normal:0,barter:0,fine_normal:0,fine_barter:0},"Ogre":{normal:0.30,barter:0.15,fine_normal:0.90,fine_barter:0.45},"Goblin":{normal:0.40,barter:0.20,fine_normal:1.20,fine_barter:0.60},"Imp":{normal:0.50,barter:0.25,fine_normal:1.50,fine_barter:0.75},"Irusan's (Special)":{normal:3.00,barter:0.75,fine_normal:3.00,fine_barter:0.75}};
        const marketData={
            "Normal":{
                "Tir Chonaill":[{"name":"Baby Potion","buy":11,"weight":1,"max":35,"limit":Infinity,"img":"tradeposts/normal/tir/Baby_Potion_Icon.png"},{"name":"Diet Potion","buy":26,"weight":1,"max":30,"limit":Infinity,"img":"tradeposts/normal/tir/Diet_Potion_Icon.png"},{"name":"Snore Potion","buy":62,"weight":2,"max":26,"limit":Infinity,"img":"tradeposts/normal/tir/Snore_Prevention_Potion_Icon.png"},{"name":"Ginseng","buy":134,"weight":3,"max":22,"limit":Infinity,"img":"tradeposts/normal/tir/Wild_Ginseng_Potion_Icon.png"},{"name":"Lovely Potion","buy":158,"weight":3,"max":25,"limit":Infinity,"img":"tradeposts/normal/tir/Lovely_Potion_Icon.png"}],
                "Dunbarton":[{"name":"Spider Gloves","buy":44,"weight":4,"max":14,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Spider_Gloves_Icon.png"},{"name":"Wool Boots","buy":160,"weight":8,"max":10,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Wool_Boots_Icon.png"},{"name":"Ogre Mask","buy":91,"weight":4,"max":26,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Ogre_Executioner_Mask_Icon.png"},{"name":"Incubus Suit","buy":536,"weight":25,"max":5,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Incubus_Suit_Icon.png"},{"name":"Succubus Swimsuit","buy":718,"weight":6,"max":5,"limit":Infinity,"img":"tradeposts/normal/dunbarton/Succubus_Swimsuit_Icon.png"}],
                "Bangor":[{"name":"Bangor Coal","buy":45,"weight":8,"max":10,"limit":Infinity,"img":"tradeposts/normal/bangor/Bangor_Coal_Icon.png"},{"name":"Marble","buy":301,"weight":20,"max":10,"limit":Infinity,"img":"tradeposts/normal/bangor/Marble_Icon.png"},{"name":"Topaz","buy":376,"weight":18,"max":12,"limit":Infinity,"img":"tradeposts/normal/bangor/Topaz_Icon.png"},{"name":"Highlander Ore","buy":788,"weight":25,"max":8,"limit":Infinity,"img":"tradeposts/normal/bangor/Highlander_Ore_Icon.png"},{"name":"Lead","buy":856,"weight":18,"max":16,"limit":Infinity,"img":"tradeposts/normal/bangor/Lead_Icon.png"}],
                "Emain Macha":[{"name":"Berry Granola","buy":10,"weight":3,"max":25,"limit":Infinity,"img":"tradeposts/normal/emain/Berry_Granola_Icon.png"},{"name":"Butter Beer","buy":49,"weight":4,"max":30,"limit":Infinity,"img":"tradeposts/normal/emain/Butter_Beer_Icon.png"},{"name":"Smoked Animal","buy":190,"weight":10,"max":40,"limit":Infinity,"img":"tradeposts/normal/emain/Smoked_Wild_Animal_Icon.png"},{"name":"Triple Pasta","buy":94,"weight":4,"max":32,"limit":Infinity,"img":"tradeposts/normal/emain/Triple_Pasta_Icon.png"},{"name":"Whole BBQ","buy":630,"weight":14,"max":12,"limit":Infinity,"img":"tradeposts/normal/emain/Whole_BBQ_Bear_Icon.png"}],
                "Taillteann":[{"name":"Heat Crystal","buy":11,"weight":2,"max":33,"limit":Infinity,"img":"tradeposts/normal/taillteann/Heat_Crystal_Icon.png"},{"name":"Music Box Stone","buy":37,"weight":3,"max":24,"limit":Infinity,"img":"tradeposts/normal/taillteann/Music_Box_Preservation_Stone_Icon.png"},{"name":"Palala Crystal","buy":130,"weight":6,"max":38,"limit":Infinity,"img":"tradeposts/normal/taillteann/Palala_Crystal_Icon.png"},{"name":"Circle Barrier Spikes","buy":126,"weight":3,"max":30,"limit":Infinity,"img":"tradeposts/normal/taillteann/Circle_Barrier_Spike_Crystal_Icon.png"},{"name":"Alchemy Crystal","buy":720,"weight":5,"max":8,"limit":Infinity,"img":"tradeposts/normal/taillteann/Alchemy_Crystal_Icon.png"}],
                "Tara":[{"name":"Mini Dressing Table","buy":205,"weight":15,"max":10,"limit":Infinity,"img":"tradeposts/normal/tara/Mini_Dressing_Table_Icon.png"},{"name":"Tea Table","buy":896,"weight":38,"max":3,"limit":Infinity,"img":"tradeposts/normal/tara/Tea_Table_Icon.png"},{"name":"Rocking Chair","buy":918,"weight":25,"max":5,"limit":Infinity,"img":"tradeposts/normal/tara/Rocking_Chair_Icon.png"},{"name":"Bunk Bed","buy":3690,"weight":60,"max":3,"limit":Infinity,"img":"tradeposts/normal/tara/Bunk_Bed_Icon.png"},{"name":"Giant Wine Rack","buy":8640,"weight":90,"max":2,"limit":Infinity,"img":"tradeposts/normal/tara/Giant_Wine_Rack_Icon.png"}],
                "Cobh":[{"name":"Cobh Seaweed","buy":11,"weight":2,"max":32,"limit":Infinity,"img":"tradeposts/normal/cobh/Cobh_Seaweed_Icon.png"},{"name":"Cobh Oyster","buy":46,"weight":3,"max":26,"limit":Infinity,"img":"tradeposts/normal/cobh/Cobh_Oyster_Icon.png"},{"name":"Shark Fin","buy":264,"weight":10,"max":25,"limit":Infinity,"img":"tradeposts/normal/cobh/Shark_Fin_Icon.png"},{"name":"Jellyfish","buy":201,"weight":6,"max":30,"limit":Infinity,"img":"tradeposts/normal/cobh/Jelly_Fish_Icon.png"},{"name":"Neid Scale","buy":187,"weight":2,"max":28,"limit":Infinity,"img":"tradeposts/normal/cobh/Neid_Scales_Icon.png"}],
                "Belvast":[{"name":"Iron Whip","buy":103,"weight":8,"max":15,"limit":Infinity,"img":"tradeposts/normal/belvast/Iron_Whip_Icon.png"},{"name":"Dark Sword","buy":477,"weight":12,"max":10,"limit":Infinity,"img":"tradeposts/normal/belvast/Dark_Sword_Icon.png"},{"name":"Safe","buy":9757,"weight":90,"max":2,"limit":Infinity,"img":"tradeposts/normal/belvast/Safe_Icon.png"},{"name":"Skeleton Armour","buy":15546,"weight":115,"max":1,"limit":Infinity,"img":"tradeposts/normal/belvast/Skeleton_Ogre_Armor_Icon.png"},{"name":"Fake Helmet","buy":4740,"weight":30,"max":6,"limit":Infinity,"img":"tradeposts/normal/belvast/Fake_Morgant_Helmet_Icon.png"}],
                "Qilla":[{"name":"Mint Chocolate Powder","buy":35,"weight":1,"max":60,"limit":Infinity,"img":"tradeposts/normal/qilla/Mint_Chocolate_Powder_Icon.png"},{"name":"Pomegranate","buy":58,"weight":2,"max":50,"limit":Infinity,"img":"tradeposts/normal/qilla/Fresh_Pomegranate_Icon.png"},{"name":"Mana Tunnel Figure","buy":102,"weight":2,"max":65,"limit":Infinity,"img":"tradeposts/normal/qilla/Mana_Tunnel_Figure_Icon.png"},{"name":"Exploration Rescue Kit","buy":247,"weight":3,"max":38,"limit":Infinity,"img":"tradeposts/normal/qilla/Exploration_Rescue_Kit_Icon.png"},{"name":"Kaypi Cactus Essence","buy":566,"weight":2,"max":26,"limit":Infinity,"img":"tradeposts/normal/qilla/Kaypi_Cactus_Essence_Icon.png"}],
                "Filia":[{"name":"Small Glass Chunk","buy":72,"weight":10,"max":60,"limit":Infinity,"img":"tradeposts/normal/filia/Small_Glass_Chunk_Icon.png"},{"name":"Cinnamon Perfume","buy":564,"weight":22,"max":15,"limit":Infinity,"img":"tradeposts/normal/filia/Cinnamon_Perfume_Icon.png"},{"name":"Dried Saffron","buy":906,"weight":25,"max":10,"limit":Infinity,"img":"tradeposts/normal/filia/Dried_Saffron_Icon.png"},{"name":"Longa Rock Salt","buy":2342,"weight":40,"max":5,"limit":Infinity,"img":"tradeposts/normal/filia/Longa_Natural_Rock_Salt_Icon.png"},{"name":"Filia Jerky","buy":1567,"weight":20,"max":12,"limit":Infinity,"img":"tradeposts/normal/filia/Filia_Jerky_Icon.png"}],
                "Cor":[{"name":"Courcle Ruins Souvenir","buy":8,"weight":2,"max":50,"limit":Infinity,"img":"tradeposts/normal/cor/Courcle_Ruins_Souvenir_Icon.png"},{"name":"Large Ritual Mask","buy":61,"weight":3,"max":40,"limit":Infinity,"img":"tradeposts/normal/cor/Large_Ritual_Mask_Icon.png"},{"name":"La Terra Raspberry","buy":56,"weight":2,"max":60,"limit":Infinity,"img":"tradeposts/normal/cor/La_Terra_Raspberry_Icon.png"},{"name":"Artifact Rest. Tool","buy":81,"weight":2,"max":70,"limit":Infinity,"img":"tradeposts/normal/cor/Artifact_Restoration_Tool_Set_Icon.png"},{"name":"Courcle Natural Rubber","buy":935,"weight":5,"max":8,"limit":Infinity,"img":"tradeposts/normal/cor/Courcle_Natural_Rubber_Icon.png"}],
                "Vales":[{"name":"Vales Coat","buy":30,"weight":1,"max":50,"limit":Infinity,"img":"tradeposts/normal/vales/Vales_Padded_Coat_Icon.png"},{"name":"Glacial Water","buy":118,"weight":2,"max":35,"limit":Infinity,"img":"tradeposts/normal/vales/Natural_Glacial_Water_Icon.png"},{"name":"Ice Skates","buy":216,"weight":1,"max":50,"limit":Infinity,"img":"tradeposts/normal/vales/Ice_Skates_Icon.png"},{"name":"Snowboard","buy":1079,"weight":3,"max":20,"limit":Infinity,"img":"tradeposts/normal/vales/Snowboard_Icon.png"},{"name":"Vales Vodka","buy":1204,"weight":2,"max":16,"limit":Infinity,"img":"tradeposts/normal/vales/Vales_Vodka_Icon.png"}]
            },
            "Barter":{
                "Karu Forest":[{"name":"Wooden Table","buy":0,"weight":15,"max":10,"limit":25,"img":"tradeposts/barter/karu/Wooden_Table_Icon.png"},{"name":"Wooden Craft","buy":0,"weight":15,"max":7,"limit":15,"img":"tradeposts/barter/karu/Wooden_Craft_Icon.png"},{"name":"Stone Horse Statue","buy":0,"weight":20,"max":7,"limit":10,"img":"tradeposts/barter/karu/Stone_Horse_Statue_Icon.png"},{"name":"Karu Mushroom","buy":0,"weight":25,"max":7,"limit":8,"img":"tradeposts/barter/karu/Karu_Shiitake_Mushroom_Icon.png"},{"name":"Shellfish Fossil","buy":0,"weight":30,"max":5,"limit":3,"img":"tradeposts/barter/karu/Shellfish_Fossil_Icon.png"}],
                "Oasis":[{"name":"Fine Sand","buy":0,"weight":15,"max":10,"limit":25,"img":"tradeposts/barter/oasis/Fine_Sand_Icon.png"},{"name":"Prison Ghost Wings","buy":0,"weight":15,"max":7,"limit":15,"img":"tradeposts/barter/oasis/Prison_Ghost_Wings_Icon.png"},{"name":"Oasis Painting","buy":0,"weight":20,"max":7,"limit":10,"img":"tradeposts/barter/oasis/Oasis_Painting_Icon.png"},{"name":"Cactus Flower","buy":0,"weight":25,"max":7,"limit":8,"img":"tradeposts/barter/oasis/Cactus_Flower_Icon.png"},{"name":"Giant Canine Fossil","buy":0,"weight":30,"max":5,"limit":3,"img":"tradeposts/barter/oasis/Giant_Canine_Fossil_Icon.png"}],
                "Lake Calida":[{"name":"Elvan Egg","buy":0,"weight":15,"max":10,"limit":25,"img":"tradeposts/barter/calida/Elvan_Egg_Icon.png"},{"name":"Salmon","buy":0,"weight":15,"max":7,"limit":15,"img":"tradeposts/barter/calida/Calida_Salmon_Icon.png"},{"name":"Bath Bomb","buy":0,"weight":20,"max":7,"limit":10,"img":"tradeposts/barter/calida/Hot_Spring_Bath_Bomb_Icon.png"},{"name":"Large Tent","buy":0,"weight":25,"max":7,"limit":8,"img":"tradeposts/barter/calida/Large_Camping_Tent_Icon.png"},{"name":"Pink Salt","buy":0,"weight":30,"max":5,"limit":3,"img":"tradeposts/barter/calida/Pink_Salt_Icon.png"}],
                "Pera Volcano":[{"name":"Mud Pack","buy":0,"weight":15,"max":10,"limit":25,"img":"tradeposts/barter/pera/Volcanic_Mud_Pack_Icon.png"},{"name":"Magma Stone","buy":0,"weight":15,"max":7,"limit":15,"img":"tradeposts/barter/pera/Magma_Stone_Icon.png"},{"name":"Ixion Horn","buy":0,"weight":20,"max":7,"limit":10,"img":"tradeposts/barter/pera/Ixion_Horn_Icon.png"},{"name":"Lizard Egg","buy":0,"weight":25,"max":7,"limit":8,"img":"tradeposts/barter/pera/Volcano_Lizard_Egg_Icon.png"},{"name":"Leopard Leather","buy":0,"weight":30,"max":5,"limit":3,"img":"tradeposts/barter/pera/Raspa_Black_Leopard_Leather_Icon.png"}],
                "Scathach Beach":[{"name":"Ocean Tear","buy":0,"weight":7,"max":15,"limit":100,"img":"tradeposts/barter/scathach/Ocean_Tear.png"},{"name":"Alluring Stem","buy":0,"weight":15,"max":10,"limit":100,"img":"tradeposts/barter/scathach/Allure_Stem.png"},{"name":"Abyss Crystal","buy":0,"weight":5,"max":15,"limit":100,"img":"tradeposts/barter/scathach/Abyss_Crystal.png"},{"name":"Sage Crystal","buy":0,"weight":10,"max":15,"limit":100,"img":"tradeposts/barter/scathach/Sage_Crystal.png"},{"name":"River's Source","buy":0,"weight":25,"max":10,"limit":100,"img":"tradeposts/barter/scathach/River_Source.png"},{"name":"Night Leather","buy":0,"weight":4,"max":30,"limit":100,"img":"tradeposts/barter/scathach/Night_Sky_Leather.png"},{"name":"Fish","buy":0,"weight":5,"max":20,"limit":100,"img":"tradeposts/barter/scathach/Unidentified_Fish.png"},{"name":"Crystal Blade","buy":0,"weight":15,"max":10,"limit":100,"img":"tradeposts/barter/scathach/Crystal_Blade.png"}]
            },
            "Group":{
                "Qilla":[{"name":"Building Lumber","buy":571,"weight":15,"max":8,"limit":144,"img":"tradeposts/group/qilla/Building_Lumber_Icon.png"},{"name":"Ancient Fossil Specimen","buy":550,"weight":8,"max":10,"limit":180,"img":"tradeposts/group/qilla/Ancient_Fossil_Specimen_Icon.png"},{"name":"Personal Camping Tent","buy":951,"weight":20,"max":7,"limit":125,"img":"tradeposts/group/qilla/Personal_Camping_Tent_Icon.png"},{"name":"Lutra Freshwater Eel","buy":657,"weight":7,"max":11,"limit":198,"img":"tradeposts/group/qilla/Lutra_Freshwater_Eel_Icon.png"},{"name":"Kaypi Red Clay","buy":919,"weight":6,"max":8,"limit":144,"img":"tradeposts/group/qilla/Kaypi_Red_Clay_Icon.png"}],
                "Filia":[{"name":"Sun Hourglass","buy":2003,"weight":70,"max":12,"limit":35,"img":"tradeposts/group/filia/Sun_Hourglass_Icon.png"},{"name":"Shyllien Icebox","buy":3724,"weight":120,"max":5,"limit":20,"img":"tradeposts/group/filia/Shyllien_Icebox_Icon.png"},{"name":"Desert-Terrain Wheel","buy":3078,"weight":90,"max":7,"limit":25,"img":"tradeposts/group/filia/Desert-Terrain_Wheel_Icon.png"},{"name":"Filia Traditional Carpet","buy":1486,"weight":35,"max":20,"limit":71,"img":"tradeposts/group/filia/Filia_Traditional_Carpet_Icon.png"},{"name":"Gem Parasol","buy":905,"weight":20,"max":25,"limit":125,"img":"tradeposts/group/filia/Gem_Parasol_Icon.png"}],
                "Cor":[{"name":"Lipai Pattern Textile","buy":342,"weight":6,"max":15,"limit":270,"img":"tradeposts/group/cor/Lipai_Pattern_Textile_Icon.png"},{"name":"Cor Honeycomb","buy":474,"weight":12,"max":13,"limit":208,"img":"tradeposts/group/cor/Cor_Honeycomb_Icon.png"},{"name":"Swamp Ash","buy":18,"weight":18,"max":9,"limit":138,"img":"tradeposts/group/cor/Swamp_Ash_Icon.png"},{"name":"Rosewood","buy":1084,"weight":25,"max":10,"limit":100,"img":"tradeposts/group/cor/Rosewood_Icon.png"},{"name":"Ebony","buy":1358,"weight":28,"max":8,"limit":89,"img":"tradeposts/group/cor/Ebony_Icon.png"}],
                "Vales":[{"name":"Calida Flint","buy":503,"weight":5,"max":10,"limit":180,"img":"tradeposts/group/vales/Calida_Flint_Icon.png"},{"name":"Physis Sled","buy":1238,"weight":10,"max":5,"limit":90,"img":"tradeposts/group/vales/Physis_Sled_Icon.png"},{"name":"Portable Hand Warmer","buy":723,"weight":2,"max":10,"limit":180,"img":"tradeposts/group/vales/Portable_Hand_Warmer_Icon.png"},{"name":"Ice Statue","buy":982,"weight":8,"max":8,"limit":144,"img":"tradeposts/group/vales/Ice_Statue_Icon.png"},{"name":"Hillwen Commemorative Coin","buy":604,"weight":4,"max":15,"limit":270,"img":"tradeposts/group/vales/Hillwen_Commemorative_Coin_Icon.png"}]
            }
        };

        // --- 2. STATE ---
        let currentItem = null;
        let publicPrices = {};
        let publicStocks = {};
        let publicBasePrices = {};
        let transportOwnership = { "Hand Cart": true, "Wagon": true, "Elephant": true, "Husky": true, "Camel": true, "Skiff": true, "Air Ship": false };
        let activeTransport = "Elephant";
        let activeCommerceType = "Normal";
        let selectedCity = "Tir Chonaill";
        let townRatings = {}; // NEW STATE FOR RATINGS

        let currentUser = null;
        let saveTimeout = null;
        let rtdb = null;
        let auth = null;
        let skipRender = false;

        // --- 3. HELPERS ---
        function getImagePath(path) {
            if (!path) return "";
            return (path.startsWith('images/') || path.startsWith('http')) ? path : `images/${path}`;
        }
        
        const applyIcon = (el, name) => {
            let p = null; 
            if(townIcons[name]) {
                p = getImagePath(townIcons[name]);
            } else if(name === "Wagon") {
                p = document.getElementById('alpaca-check').checked ? 'images/transports/Alpaca_Wagon_Icon.png' : 'images/transports/Wagon_Icon.png';
            } else if(transportIcons[name]) {
                p = transportIcons[name];
            } else { 
                const i = commerceDbFind(name);
                if(i) p = getImagePath(i.img); 
            }
            if(p) el.style.backgroundImage = `url('${p}')`; 
            else el.style.backgroundImage = 'none';
        };

        function commerceDbFind(name) {
            for (let type in marketData) {
                for (let town in marketData[type]) {
                    const found = marketData[type][town].find(i => i.name === name);
                    if (found) return found;
                }
            }
            return null;
        }

        // --- 4. LOGIC ---
        function getStock(itemName) { return publicStocks[itemName] || 0; }
        function getPrice(itemName, city) { return publicPrices[`${itemName}_${city}`.replace(/[.#$[\]]/g, "_")] || 0; }

        function getUIState() {
            return {
                commerceType: activeCommerceType,
                transport: activeTransport,
                city: selectedCity,
                // UI State reads directly from input for active calculation
                merchantRating: parseInt(document.getElementById('merchant-rating-input').value, 10) || 1,
                trader: parseInt(document.getElementById('trader-qty').value, 10) || 0,
                trust: parseInt(document.getElementById('trustworthy-qty').value, 10) || 0,
                mastery: document.getElementById('mastery-rank').value,
                letter: document.getElementById('letter-select').value,
                fine: document.getElementById('fine-letter-check').checked,
                gm: document.getElementById('gm-check').checked,
                william: document.getElementById('william-check').checked,
                williamLike: parseInt(document.getElementById('william-likeability').value) || 0,
                alpaca: document.getElementById('alpaca-check').checked
            };
        }

        function getDiscountedBuyPrice(base, uiState) {
            const r = uiState.merchantRating;
            const mD = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 1, 6: 1, 7: 2, 8: 2, 9: 3 }[r] || 0;
            const gear = (uiState.trader * 3) + uiState.trust;
            return Math.floor(base * (1 - ((mD + gear) / 100)));
        }

        function getModifiedStats(mName, uiState) {
            const b = transportData[mName];
            if (!b) return { slots: 0, weight: 0 };
            let bW = 0, bS = 0;
            if (uiState.gm) { bW += 100; bS += 1; }
            if (mName !== "Air Ship" && uiState.william) { bW += 200; bS += 1; }
            if (mName === "Wagon" && uiState.alpaca) { bW += 200; bS += 2; }
            return { slots: b.slots + bS, weight: b.weight + bW };
        }

        function getActiveModifiers(uiState) {
            const masteryBonus = masteryRanks[uiState.mastery] || 0;
            const letterInfo = guaranteeLetters[uiState.letter] || guaranteeLetters["None"];
            let letterMultiplier = (uiState.commerceType === "Barter") ? (uiState.fine ? letterInfo.fine_barter : letterInfo.barter) : (uiState.fine ? letterInfo.fine_normal : letterInfo.normal);
            let williamBonus = 0;
            if (uiState.william) {
                const like = uiState.williamLike;
                if (like >= 240) williamBonus = 0.03;
                else if (like >= 130) williamBonus = 0.02;
                else if (like >= 80) williamBonus = 0.01;
            }
            return { totalMultiplier: (1 + masteryBonus + letterMultiplier + williamBonus) };
        }

        function calculateItemProfit(item, targetCity, uiState, sellPriceOverride = null) {
            const sellVal = sellPriceOverride !== null ? sellPriceOverride : getPrice(item.name, targetCity);
            const basePrice = publicBasePrices[item.name] || item.buy;
            const dBuy = getDiscountedBuyPrice(basePrice, uiState);
            const stats = getModifiedStats(uiState.transport, uiState);
            const load = Math.min(Math.floor(stats.weight / item.weight), stats.slots * item.max, item.limit);
            
            // Item Profit Logic: Total Base Profit for stack * Multiplier
            const baseProfit = (sellVal !== "" && sellVal > 0) ? (sellVal - dBuy) * load : 0;
            const mods = getActiveModifiers(uiState);
            let finalProfit = baseProfit > 0 ? Math.floor(baseProfit * mods.totalMultiplier) : baseProfit;
            
            const divisor = (uiState.commerceType === "Barter") ? 34 : 17;
            const score = Math.max(0, Math.floor(((sellVal - (item.buy || 0)) * load) / divisor));
            return { profit: finalProfit, score: score, load: load };
        }

        function renderCommerceTabs() {
            const container = document.getElementById('commerce-type-tabs');
            if (!container) return;
            container.innerHTML = '';
            ["Normal", "Barter", "Group"].forEach(type => {
                const btn = document.createElement('div');
                btn.className = `picker-btn ${activeCommerceType === type ? 'active' : ''}`;
                btn.onclick = () => { 
                    activeCommerceType = type; 
                    const valid = citiesByType[type];
                    if(valid.length > 0) selectedCity = valid[0];
                    renderCommerceTabs(); 
                    renderCityTabs(); 
                    renderTransportTabs(); 
                    
                    // Update rating input for new city
                    document.getElementById('merchant-rating-input').value = townRatings[selectedCity] || 1;
                    
                    refreshUI(); 
                    savePrefs(); 
                };
                const label = document.createElement('div');
                label.className = 'picker-label';
                label.style.padding = "5px 0";
                label.innerText = type;
                btn.append(label);
                container.appendChild(btn);
            });
        }

        function renderTransportTabs() {
            const container = document.getElementById('transport-tabs');
            if (!container) return;
            container.innerHTML = '';
            const uiState = getUIState();
            const mounts = ['Back Pack', 'Hand Cart', 'Wagon', 'Elephant', 'Husky', 'Camel', 'Skiff'];
            if (activeCommerceType === 'Group') mounts.push('Air Ship');

            mounts.forEach(t => {
                if (!transportOwnership[t] && t !== 'Back Pack') return;
                const btn = document.createElement('div');
                btn.className = `picker-btn ${activeTransport === t ? 'active' : ''}`;
                btn.onclick = () => { activeTransport = t; renderTransportTabs(); refreshUI(); savePrefs(); };
                const icon = document.createElement('div');
                icon.className = 'picker-icon';
                applyIcon(icon, t);
                const label = document.createElement('div');
                label.className = 'picker-label';
                label.innerText = (t === "Wagon" && uiState.alpaca) ? "Alpaca Wagon" : t;
                btn.append(icon, label);
                container.appendChild(btn);
            });
        }

        function renderCityTabs() {
            const container = document.getElementById('city-tabs');
            if (!container) return;
            container.innerHTML = '';
            const valid = citiesByType[activeCommerceType];
            valid.forEach(city => {
                const btn = document.createElement('div');
                btn.className = `picker-btn ${selectedCity === city ? 'active' : ''}`;
                btn.onclick = () => { 
                    selectedCity = city; 
                    
                    // Update rating input for selected city
                    document.getElementById('merchant-rating-input').value = townRatings[city] || 1;
                    
                    renderCityTabs(); 
                    refreshUI(); 
                    savePrefs(); 
                };
                const icon = document.createElement('div');
                icon.className = 'picker-icon';
                applyIcon(icon, city);
                const label = document.createElement('div');
                label.className = 'picker-label';
                label.innerText = city;
                btn.append(icon, label);
                container.appendChild(btn);
            });
        }

        function runManifests(uiState) {
            const origin = selectedCity;
            if(!origin) return;
            const targetPool = (activeCommerceType === "Barter" ? citiesByType["Normal"] : citiesByType[activeCommerceType]);
            const targets = targetPool.filter(c => c !== origin);
            const originItems = (marketData[activeCommerceType] && marketData[activeCommerceType][origin]) || [];
            const localResult = calculateBestRouteForVector(origin, targets, originItems, uiState, activeTransport);
            renderManifest(localResult.best, 'manifest-box', 'manifest-list', 'manifest-total');
        }

        function calculateBestRouteForVector(originCity, targetCities, originItems, uiState, mount) {
            let best = null, maxP = -1;
            const mods = getActiveModifiers(uiState);
            const stats = getModifiedStats(mount, uiState);
            targetCities.forEach(targetCity => {
                let remWeight = stats.weight, remSlots = stats.slots, totalP = 0, itemsToBuy = [];
                
                // Calculate potential per unit
                const potential = originItems.map(item => {
                    const basePrice = publicBasePrices[item.name] || item.buy;
                    const dBuy = getDiscountedBuyPrice(basePrice, uiState);
                    const sellVal = getPrice(item.name, targetCity);
                    
                    // Raw unit profit (no multipliers) for sorting efficiency
                    const rawUnitP = (sellVal - dBuy);
                    
                    // Multiplier applied to efficiency sort to favor high-base-value items correctly
                    const effP = rawUnitP > 0 ? (rawUnitP * mods.totalMultiplier) : rawUnitP;
                    
                    return { ...item, rawUnitP, dBuy, sellVal, eff: effP / Math.max(1, item.weight) };
                }).filter(i => i.rawUnitP > 0).sort((a, b) => b.eff - a.eff);
                
                potential.forEach(item => {
                    const stock = getStock(item.name);
                    let qty = Math.min(Math.floor(remWeight / item.weight), remSlots * item.max, item.limit, stock);
                    if (qty <= 0) return;
                    
                    let slotsNeeded = Math.ceil(qty / item.max);
                    
                    // FIXED MATH: Total Base Profit * Multiplier -> Floor
                    const totalBase = item.rawUnitP * qty;
                    const stackProfit = Math.floor(totalBase * mods.totalMultiplier);
                    
                    itemsToBuy.push({ n: item.name, q: qty, p: stackProfit, img: item.img, s: slotsNeeded, maxPerSlot: item.max });
                    remWeight -= (qty * item.weight); remSlots -= slotsNeeded; totalP += stackProfit;
                });
                if (totalP > maxP) { maxP = totalP; best = { origin: originCity, dest: targetCity, mount: mount, items: itemsToBuy, profit: totalP, maxSlots: stats.slots }; }
            });
            return { best, maxP };
        }

        function renderManifest(trip, boxId, listId, totalId) {
            const box = document.getElementById(boxId), list = document.getElementById(listId), total = document.getElementById(totalId);
            if (!trip || trip.profit <= 0) {
                box.style.display = 'block';
                list.innerHTML = `<div style="color:var(--text-dim); font-size:10px; padding:10px; text-align:center;">NO PROFITABLE ROUTES</div>`;
                return;
            }
            box.style.display = 'block';
            document.getElementById('manifest-dest').innerText = trip.dest;
            let slotHtml = '';
            let filled = 0;
            trip.items.forEach(item => {
                let rem = item.q;
                for (let i = 0; i < item.s; i++) {
                    const sqty = Math.min(item.maxPerSlot, rem); rem -= sqty;
                    slotHtml += `<div class="slot filled" style="background-image: url('${getImagePath(item.img)}');"><span class="slot-badge">${sqty}</span></div>`;
                    filled++;
                }
            });
            for (let i = filled; i < trip.maxSlots; i++) slotHtml += `<div class="slot"></div>`;
            list.innerHTML = slotHtml;
            total.textContent = `+${trip.profit.toLocaleString()}`;
        }

        function refreshUI() {
            if (document.activeElement && (document.activeElement.classList.contains('input-dark'))) return;
            const uiState = getUIState(); 
            updateMarketItems(uiState); 
            showPrices(uiState); 
            updatePreview(uiState); 
            updateTownIcon(); 
            runManifests(uiState);
            const wCheck = document.getElementById('william-check');
            const wBox = document.getElementById('william-like-box');
            if(wCheck && wBox) wBox.style.display = wCheck.checked ? 'flex' : 'none';
        }

        function updatePreview(uiState) {
            if (!currentItem) return;
            document.getElementById('center-item-icon').style.backgroundImage = `url('${getImagePath(currentItem.img)}')`;
            document.getElementById('center-item-title').textContent = currentItem.name;
            const currentBase = publicBasePrices[currentItem.name] || currentItem.buy;
            document.getElementById('base-price-input').value = currentBase;
            document.getElementById('base-price-container').style.display = 'flex';
            document.getElementById('weight-display').textContent = `Weight: ${currentItem.weight}`;
            document.getElementById('stack-display').textContent = `Stack: ${currentItem.max}`;
        }

        function updateTownIcon() {
            const avatar = document.getElementById('origin-town-icon');
            if (avatar) applyIcon(avatar, selectedCity);
        }

        function updateMarketItems(uiState) {
            const container = document.getElementById('market-items-container');
            container.innerHTML = '';
            const type = activeCommerceType;
            const city = selectedCity;
            if(!city) return; 
            let items = (marketData[type] && marketData[type][city]) || [];
            if (items.length > 0 && (!currentItem || !items.find(i => i.name === currentItem.name))) { currentItem = items[0]; updatePreview(uiState); }
            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const isSelected = currentItem && currentItem.name === item.name;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item' + (isSelected ? ' selected-item' : '');
                const cStock = getStock(item.name);
                itemDiv.innerHTML = `<div class="item-icon-box" style="background-image: url('${getImagePath(item.img)}')"></div><div class="item-list-content"><div><span class="item-name">${item.name}</span></div><div class="stock-input-row"><span style="font-size:9px; color:var(--text-dim);">STOCK</span><input type="number" class="qty-input input-dark" value="${cStock || ''}" placeholder="0" onfocus="this.select()" onclick="event.stopPropagation()" onchange="updateStock('${item.name.replace(/'/g, "\\'")}', this.value)" style="width: 70px; text-align: right; padding: 2px 6px; height: 22px;"></div></div>`;
                itemDiv.addEventListener('click', () => { currentItem = item; refreshUI(); if (window.innerWidth <= 1000) closeSidebars(); });
                fragment.appendChild(itemDiv);
            });
            container.appendChild(fragment);
        }

        function showPrices(uiState) {
            const list = document.getElementById('profit-list');
            list.innerHTML = '';
            if (!currentItem) return;
            const type = activeCommerceType;
            const origin = selectedCity;
            const fragment = document.createDocumentFragment();
            (type === "Barter" ? citiesByType["Normal"] : citiesByType[type]).filter(c => c !== origin).forEach(city => {
                const sellVal = getPrice(currentItem.name, city);
                const res = calculateItemProfit(currentItem, city, uiState, sellVal);
                const row = document.createElement('div');
                row.className = 'market-row';
                
                // Add input event to update siblings immediately
                const priceInput = document.createElement('input');
                priceInput.type = 'number';
                priceInput.className = 'price-input input-dark';
                priceInput.value = sellVal || '';
                priceInput.style.textAlign = 'right';
                priceInput.onfocus = function() { this.select(); };
                priceInput.oninput = function() {
                   const val = this.value;
                   updatePrice(city, val);
                   // Immediate UI update
                   const newVal = parseInt(val) || 0;
                   const updatedRes = calculateItemProfit(currentItem, city, getUIState(), newVal);
                   row.querySelector('.profit-val').textContent = updatedRes.profit.toLocaleString();
                   row.querySelector('.score-val').textContent = updatedRes.score.toLocaleString();
                   if(updatedRes.profit < 0) row.querySelector('.profit-val').classList.add('negative');
                   else row.querySelector('.profit-val').classList.remove('negative');
                };

                row.innerHTML = `<div><b>${city}</b></div><div></div><div class="profit-val ${res.profit < 0 ? 'negative' : ''}">${res.profit.toLocaleString()}</div><div class="score-val">${res.score.toLocaleString()}</div>`;
                row.children[1].appendChild(priceInput);
                fragment.appendChild(row);
            });
            list.appendChild(fragment);
        }

        function updatePrice(city, val) {
            if (!currentItem) return;
            const sellVal = parseInt(val, 10) || 0;
            const priceKey = `${currentItem.name}_${city}`.replace(/[.#$[\]]/g, "_");
            publicPrices[priceKey] = sellVal;
            skipRender = true;
            if(rtdb) rtdb.ref(`public_commerce/prices/${priceKey}`).set(sellVal);
            runManifests(getUIState());
        }

        function updateStock(itemName, quantity) {
            const qty = parseInt(quantity) || 0;
            publicStocks[itemName] = qty;
            skipRender = true;
            if(rtdb) rtdb.ref(`public_commerce/stocks/${itemName}`).set(qty);
            runManifests(getUIState());
        }

        function updateBasePrice(val) {
            if (!currentItem) return;
            const price = parseInt(val) || 0;
            publicBasePrices[currentItem.name] = price;
            skipRender = true;
            if(rtdb) rtdb.ref(`public_commerce/base_prices/${currentItem.name}`).set(price);
            refreshUI();
        }

        function validateRating(input) {
            let val = parseInt(input.value);
            if(val < 1) val = 1;
            if(val > 9) val = 9;
            input.value = val;
            
            // Save specific rating for current town
            townRatings[selectedCity] = val;
            
            refreshUI();
            savePrefs();
        }

        function savePrefs() {
            const prefs = getUIState();
            prefs.transports = transportOwnership;
            prefs.activeTransport = activeTransport;
            prefs.city = document.getElementById('city-select').value;
            prefs.townRatings = townRatings; // SAVE MAP

            localStorage.setItem('mabi_prefs', JSON.stringify(prefs));
            if (currentUser && rtdb) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => { rtdb.ref(`users/${currentUser.uid}/settings`).update(prefs); }, 1000);
            }
        }

        function toggleSidebar(side) {
            const left = document.getElementById('left-panel'), right = document.getElementById('right-panel'), backdrop = document.getElementById('mobile-backdrop');
            if (side === 'left') { left.classList.toggle('active'); backdrop.classList.toggle('active', left.classList.contains('active')); right.classList.remove('active'); }
            else { right.classList.toggle('active'); backdrop.classList.toggle('active', right.classList.contains('active')); left.classList.remove('active'); }
        }

        function closeSidebars() {
            document.getElementById('left-panel').classList.remove('active');
            document.getElementById('right-panel').classList.remove('active');
            document.getElementById('mobile-backdrop').classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const saved = JSON.parse(localStorage.getItem('mabi_prefs')) || {};
            
            if (saved.townRatings) townRatings = saved.townRatings; // LOAD MAP

            document.getElementById('mastery-rank').innerHTML = Object.keys(masteryRanks).map(r => `<option value="${r}">Rank ${r} (+${Math.round(masteryRanks[r]*100)}%)</option>`).join('');
            document.getElementById('letter-select').innerHTML = ["None", "Ogre", "Goblin", "Imp", "Irusan's (Special)"].map(n => `<option value="${n}">${n}</option>`).join('');
            document.querySelectorAll('.transport-toggle').forEach(toggle => {
                toggle.onchange = (e) => { transportOwnership[toggle.dataset.mount] = e.target.checked; savePrefs(); renderTransportTabs(); refreshUI(); };
            });
            document.getElementById('merchant-rating-input').onchange = (e) => validateRating(e.target);
            ['trader-qty', 'trustworthy-qty', 'mastery-rank', 'letter-select', 'fine-letter-check', 'gm-check', 'william-likeability'].forEach(id => {
                document.getElementById(id).onchange = () => { refreshUI(); savePrefs(); };
            });
            document.getElementById('william-check').onchange = function() { if (this.checked) document.getElementById('alpaca-check').checked = false; refreshUI(); savePrefs(); };
            document.getElementById('alpaca-check').onchange = function() { if (this.checked) document.getElementById('william-check').checked = false; renderTransportTabs(); refreshUI(); savePrefs(); };
            
            if (saved.commerceType) activeCommerceType = saved.commerceType;
            if (saved.city) selectedCity = saved.city;
            
            // Set initial rating from map if available
            document.getElementById('merchant-rating-input').value = townRatings[selectedCity] || 1;
            
            if (saved.activeTransport) activeTransport = saved.activeTransport;
            if (saved.transports) transportOwnership = saved.transports;
            Object.keys(transportOwnership).forEach(key => {
                const toggle = document.querySelector(`.transport-toggle[data-mount="${key}"]`);
                if(toggle) toggle.checked = transportOwnership[key];
            });

            // --- RESTORE MISSING PREFS ---
            if (saved.mastery) document.getElementById('mastery-rank').value = saved.mastery;
            if (saved.letter) document.getElementById('letter-select').value = saved.letter;
            if (saved.fine !== undefined) document.getElementById('fine-letter-check').checked = saved.fine;
            if (saved.gm !== undefined) document.getElementById('gm-check').checked = saved.gm;
            if (saved.william !== undefined) document.getElementById('william-check').checked = saved.william;
            if (saved.williamLike) document.getElementById('william-likeability').value = saved.williamLike;
            if (saved.alpaca !== undefined) document.getElementById('alpaca-check').checked = saved.alpaca;
            if (saved.trader) document.getElementById('trader-qty').value = saved.trader;
            if (saved.trust) document.getElementById('trustworthy-qty').value = saved.trust;
            
            renderCommerceTabs(); renderTransportTabs(); renderCityTabs(); refreshUI();

            const firebaseConfig = {
                apiKey: "AIzaSyC7A3Rzi-VddhqZiFGjHjjqBwCdX1ks6yM",
                authDomain: "mabinogi-tracker.firebaseapp.com",
                databaseURL: "https://mabinogi-tracker-default-rtdb.firebaseio.com",
                projectId: "mabinogi-tracker",
                storageBucket: "mabinogi-tracker.firebasestorage.app",
                appId: "1:267690802644:web:fccdd005d5c8990504ea41"
            };
            firebase.initializeApp(firebaseConfig);
            rtdb = firebase.database();
            auth = firebase.auth();
            rtdb.ref('public_commerce/prices').on('value', (s) => { if (!skipRender) { publicPrices = s.val() || {}; refreshUI(); } skipRender = false; });
            rtdb.ref('public_commerce/stocks').on('value', (s) => { if (!skipRender) { publicStocks = s.val() || {}; refreshUI(); } skipRender = false; });
            rtdb.ref('public_commerce/base_prices').on('value', (s) => { if (!skipRender) { publicBasePrices = s.val() || {}; refreshUI(); } skipRender = false; });
            
            // --- AUTHENTICATION LISTENER: UPDATED TO REMOVE TRANSFORMATION ---
            auth.onAuthStateChanged(user => {
                const displayElem = document.getElementById('user-display');
                if (user) {
                    currentUser = user;
                    
                    // 1. Initial fallback using email prefix (no transform)
                    displayElem.textContent = user.email.split('@')[0];

                    // 2. Try instant load from local settings cache (no transform)
                    const cached = JSON.parse(localStorage.getItem('mabi_user_cache_' + user.uid) || '{}');
                    if (cached.username) {
                        displayElem.textContent = cached.username;
                    }

                    // 3. Real-time sync with database profile (no transform)
                    firebase.database().ref(`users/${user.uid}/profile`).on('value', (snap) => {
                        const profile = snap.val();
                        if (profile && profile.username) {
                            displayElem.textContent = profile.username;
                            // Update local cache
                            localStorage.setItem('mabi_user_cache_' + user.uid, JSON.stringify(profile));
                        }
                    });
                } else {
                    currentUser = { uid: 'local_guest', isGuest: true };
                    displayElem.textContent = "GUEST";
                }
            });
        });
    </script>
</body>
</html>
