<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Post Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #050505;
            --sidebar-bg: #0a0a0a;
            --card-bg: #111;
            --accent: #ffd700; /* Neon Yellow */
            --border: rgba(255,255,255,0.05);
            --text-main: #d0d0d0;
            --text-dim: #444;
        }

        /* --- Global & Reset --- */
        * { box-sizing: border-box; outline: none; }
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            font-size: 12px;
            overflow-x: hidden;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #1a1a1a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- Layout Containers --- */
        .interface-container {
            width: 100%; max-width: 1500px; margin: 0 auto;
            background: var(--bg); border: 1px solid var(--border);
        }
        .header-bar { background: var(--sidebar-bg); }
        .content-grid {
            display: grid; grid-template-columns: 320px 1fr 320px; gap: 1px;
            background: var(--border);
        }
        .left-panel, .center-panel, .right-panel {
            background: var(--card-bg); min-height: 90vh;
            display: flex; flex-direction: column;
        }

        /* --- Header Elements --- */
        .decorative-border { height: 2px; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .title-section {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;
        }
        .main-title {
            font-size: 20px; font-weight: 900; color: var(--accent);
            letter-spacing: 2px; text-transform: uppercase;
        }
        .sub-title { font-size: 9px; color: var(--text-dim); letter-spacing: 1px; }
        .hub-btn {
            color: #fff; text-decoration: none; font-weight: 900; font-size: 10px;
            background: #1a1a1a; border: 1px solid var(--border); padding: 5px 10px;
            transition: 0.2s;
        }
        .hub-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 8px var(--accent); }

        /* --- Common Components --- */
        .panel-small-label {
            font-size: 9px; font-weight: 900; color: var(--text-dim);
            text-transform: uppercase; display: block; margin-bottom: 4px;
        }
        .section-header-label {
            width: 100%; margin-bottom: 8px; color: #666; font-size: 9px;
            font-weight: bold; letter-spacing: 0.5px;
        }
        .city-dropdown, .custom-dropdown, .qty-input-compact, .price-input, .qty-input, .search-input {
            background: #000; border: 1px solid #333; color: var(--accent);
            font-family: 'JetBrains Mono';
        }
        .city-dropdown, .custom-dropdown, .qty-input-compact, .search-input {
            font-size: 11px; padding: 4px;
        }
        .search-input { width: 100%; padding-right: 25px; }
        .qty-input-compact { width: 40px; text-align: center; }

        /* --- Panels --- */
        .commerce-type-section { padding: 15px; border-bottom: 1px solid var(--border); }
        .player-info {
            display: flex; gap: 10px; padding: 10px;
            border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2);
        }
        .player-avatar {
            width: 48px; height: 48px; background-color: #000;
            border: 1px solid #333; background-size: contain;
            background-repeat: no-repeat; background-position: center;
        }
        .buff-row-inline {
            display: flex; gap: 10px; padding: 10px;
            background: rgba(0,0,0,0.4); justify-content: center;
        }
        .buff-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--text-dim); }
        #market-items-container { flex-grow: 1; overflow-y: auto; background: #080808; }
        
        .inventory-item {
            display: flex; gap: 10px; padding: 8px;
            border-bottom: 1px solid var(--border); cursor: pointer;
            align-items: center; transition: 0.1s;
        }
        .inventory-item:hover { background: rgba(255,255,255,0.03); }
        .selected-item { border-left: 3px solid var(--accent); background: rgba(255,255,255,0.05); }
        
        .item-list-icon-box {
            width: 44px; height: 44px; background: #000; border: 1px solid #333;
            background-size: contain; background-repeat: no-repeat; background-position: center; flex-shrink: 0;
        }
        .item-list-content { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; }
        .item-name { font-weight: 700; font-size: 11px; color: #eee; }
        .item-town-badge { font-size: 9px; color: var(--accent); opacity: 0.7; display: block; }
        .stock-input-row { display: flex; flex-direction: column; align-items: center; width: 70px; }
        .qty-input { width: 70px; font-size: 11px; padding: 4px; text-align: center; }

        .item-header {
            padding: 20px; border-bottom: 1px solid var(--border); display: flex;
            gap: 20px; align-items: center; background: rgba(0,0,0,0.4);
        }
        .item-icon-container {
            width: 84px; height: 84px; border: 1px solid var(--border); background: #000;
            display: flex; align-items: center; justify-content: center;
        }
        .item-icon { width: 80px; height: 80px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .item-title { font-size: 18px; font-weight: 900; color: var(--accent); text-transform: uppercase; }
        .item-inventory { font-family: 'JetBrains Mono'; font-size: 10px; color: var(--text-dim); }
        .market-list-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #profit-list { overflow-y: auto; flex-grow: 1; }
        
        .market-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
            padding: 10px 15px; border-bottom: 1px solid var(--border);
            align-items: center; gap: 10px;
        }
        .market-row.header { background: rgba(255,255,255,0.02); font-weight: 900; color: var(--text-dim); font-size: 10px; }
        .market-left { display: flex; align-items: center; overflow: hidden; white-space: nowrap; }
        .price-input { font-size: 12px; width: 100%; text-align: right; height: fit-content; }
        .profit-val { font-family: 'JetBrains Mono'; font-weight: bold; text-align: right; color: var(--accent); font-size: 13px; }
        .profit-val.negative { color: #ff4444; }
        .season-val { font-family: 'JetBrains Mono'; text-align: right; color: var(--text-dim); font-size: 11px; }
        .season-val.negative { color: #ff4444; }

        .buff-row-side { padding: 15px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 12px; }
        .toggle-container {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            font-size: 10px; color: var(--text-dim); user-select: none; width: 45%;
        }
        .toggle-container:hover { color: #fff; }
        .toggle-input { display: none; }
        .toggle-slider {
            width: 28px; height: 16px; background: #222; border: 1px solid #333; border-radius: 99px;
            position: relative; transition: all 0.2s; flex-shrink: 0;
        }
        .toggle-slider::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 10px; height: 10px;
            background: #666; border-radius: 50%; transition: all 0.2s;
        }
        .toggle-input:checked + .toggle-slider { background: rgba(255, 215, 0, 0.15); border-color: var(--accent); }
        .toggle-input:checked + .toggle-slider::after { transform: translateX(12px); background: var(--accent); }

        .partner-info { padding: 15px; border-bottom: 1px solid var(--border); }
        .partner-name { font-size: 10px; font-weight: 900; color: var(--text-dim); margin-bottom: 5px; }
        
        .recommendation-box {
            margin: 15px; padding: 15px; background: rgba(0,0,0,0.3);
            border: 1px solid var(--accent); border-radius: 4px; box-shadow: 0 0 15px rgba(255,255,255,0.05);
        }
        .rec-title { color: var(--accent); font-weight: 900; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; }
        .manifest-slot {
            width: 44px; height: 44px; border: 1px solid #333; display: inline-block; margin: 2px;
            background-color: #000; background-size: contain; background-repeat: no-repeat;
            background-position: center; position: relative; cursor: pointer;
        }
        .manifest-slot.filled { border-color: var(--accent); }
        .manifest-slot.filled:hover { transform: translateY(-2px); box-shadow: 0 0 10px rgba(255,255,255,0.2); z-index: 10; }
        .manifest-slot.empty { opacity: 0.1; border-style: dashed; }
        .slot-badge {
            position: absolute; bottom: -4px; right: -4px; background: var(--accent); color: #000;
            font-size: 9px; font-weight: 900; padding: 1px 4px; border-radius: 3px; line-height: 1;
        }
        .manifest-footer { margin-top: 10px; border-top: 1px solid #333; padding-top: 5px; font-weight: 900; color: #fff; font-family: 'JetBrains Mono'; }
        
        @media (max-width: 1000px) {
            .content-grid { grid-template-columns: 1fr; }
            .interface-container { border: none; }
            .left-panel, .right-panel { min-height: auto; }
        }
    </style>
</head>
<body>
    <div class="interface-container">
        <div class="header-bar">
            <div class="decorative-border"></div>
            <div class="title-section">
                <a href="index.html" class="hub-btn">HUB</a>
                <div style="text-align:center;">
                    <span class="main-title">Trading Post</span>
                    <span class="sub-title">COMMERCE_NETWORK_SYNC</span>
                </div>
                <div style="width:80px;"></div>
            </div>
            <div class="decorative-border"></div>
        </div>

        <div class="content-grid">
            <div class="left-panel">
                <div class="commerce-type-section">
                    <label class="panel-small-label">Commerce Mode</label>
                    <select id="commerce-type-select" class="city-dropdown">
                        <option value="Normal">Normal Commerce</option>
                        <option value="Barter">Bartering</option>
                        <option value="Group">Group Commerce</option>
                    </select>

                    <div style="margin-top: 10px;">
                        <label class="panel-small-label">Global Search</label>
                        <div style="position: relative;">
                            <input type="text" id="global-search" class="search-input" placeholder="Search item...">
                            <div id="clear-search" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; display: none; color: #666; font-size: 10px;">âœ•</div>
                        </div>
                    </div>
                </div>

                <div class="player-info">
                    <div class="player-avatar" id="origin-town-icon"></div>
                    <div style="display: flex; flex-direction: column; flex-grow: 1;">
                        <label class="panel-small-label">Trade Post</label>
                        <select class="city-dropdown" id="city-select"></select>
                    </div>
                    <div style="display: flex; flex-direction: column; width: 50px;">
                        <label class="panel-small-label">Merchant Rating</label>
                        <select id="merchant-rating-select" class="city-dropdown">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                        </select>
                    </div>
                </div>

                <div class="buff-row-inline">
                    <div class="buff-item">
                        <label>Trader</label>
                        <input type="number" id="trader-qty" min="0" max="2" value="0" class="qty-input-compact">
                    </div>
                    <div class="buff-item">
                        <label>Trustworthy</label>
                        <input type="number" id="trustworthy-qty" min="0" max="2" value="0" class="qty-input-compact">
                    </div>
                </div>
                <div id="market-items-container"></div>
            </div>

            <div class="center-panel">
                <div class="item-header">
                    <div class="item-icon-container">
                        <div class="item-icon" id="center-item-icon"></div>
                    </div>
                    <div class="item-title-box">
                        <div class="item-title" id="center-item-title">Initializing...</div>
                        <div class="item-inventory" id="max-inventory-display">Select an item to begin.</div>
                    </div>
                </div>
                <div class="market-list-container">
                    <div class="market-row header">
                        <div class="market-left">TARGET</div>
                        <div class="col-price">INPUT PRICE</div>
                        <div class="market-profit-col">PROFIT</div>
                        <div class="market-score-col">SCORE</div>
                    </div>
                    <div id="profit-list"></div>
                </div>
            </div>

            <div class="right-panel">
                 <div class="buff-row-side">
                    <div class="section-header-label">PROFIT MODIFIERS</div>
                    <div style="width: 100%; margin-bottom: 5px;">
                        <label class="panel-small-label">Commerce Mastery</label>
                        <select id="mastery-rank" class="city-dropdown" style="width:100%"></select>
                    </div>
                    <div style="width: 100%; display: flex; align-items: flex-end; gap: 5px;">
                        <div style="flex-grow: 1;">
                            <label class="panel-small-label">Letter of Guarantee</label>
                            <select id="letter-select" class="city-dropdown" style="width:100%"></select>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <label class="panel-small-label" style="font-size: 8px; margin-bottom:5px;">FINE</label>
                            <label class="toggle-container" style="width: auto; margin:0;">
                                <input type="checkbox" id="fine-letter-check" class="toggle-input">
                                <div class="toggle-slider"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="buff-row-side">
                    <div class="section-header-label">ACTIVE BUFFS</div>
                    <label class="toggle-container">
                        <input type="checkbox" id="gm-check" class="toggle-input">
                        <div class="toggle-slider"></div>
                        <span>Grandmaster</span>
                    </label>
                    <div style="width: 100%; display: flex; align-items: center; justify-content: space-between;">
                        <label class="toggle-container" style="width: auto;">
                            <input type="checkbox" id="william-check" class="toggle-input">
                            <div class="toggle-slider"></div>
                            <span>William</span>
                        </label>
                        <div id="william-like-box" style="display:none; align-items: center; gap: 5px;">
                             <span style="font-size: 9px; color: #666;">Likeability</span>
                             <input type="number" id="william-likeability" class="qty-input-compact" style="width: 60px;" min="0" max="247" value="247">
                        </div>
                    </div>
                    <label class="toggle-container">
                        <input type="checkbox" id="alpaca-check" class="toggle-input">
                        <div class="toggle-slider"></div>
                        <span>Alpaca</span>
                    </label>
                </div>

                <div class="buff-row-side" style="padding-top: 10px;">
                    <div class="section-header-label">OWNED TRANSPORTS</div>
                    <label class="toggle-container">
                        <input type="checkbox" id="handcart-check" class="toggle-input transport-toggle" data-mount="Hand Cart">
                        <div class="toggle-slider"></div>
                        <span>Hand Cart</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="wagon-check" class="toggle-input transport-toggle" data-mount="Wagon">
                        <div class="toggle-slider"></div>
                        <span>Wagon</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="elephant-check" class="toggle-input transport-toggle" data-mount="Elephant">
                        <div class="toggle-slider"></div>
                        <span>Elephant</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="husky-check" class="toggle-input transport-toggle" data-mount="Husky">
                        <div class="toggle-slider"></div>
                        <span>Husky</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="camel-check" class="toggle-input transport-toggle" data-mount="Camel">
                        <div class="toggle-slider"></div>
                        <span>Camel</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="skiff-check" class="toggle-input transport-toggle" data-mount="Skiff">
                        <div class="toggle-slider"></div>
                        <span>Skiff</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="airship-check" class="toggle-input transport-toggle" data-mount="Air Ship">
                        <div class="toggle-slider"></div>
                        <span>Air Ship</span>
                    </label>
                </div>

                <div class="partner-info">
                    <div class="partner-name">Current Transport</div>
                    <select id="transport-dropdown" class="custom-dropdown"></select>
                </div>

                <div class="recommendation-box" id="manifest-box" style="display:none;">
                    <div class="rec-title">Local Best Loadout</div>
                    <div id="manifest-list"></div>
                    <div id="manifest-total" class="manifest-footer"></div>
                </div>

                <div id="global-manifest-anchor"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & DATA (HARDCODED) ---
        function getImagePath(path) {
            if (!path) return "";
            return (path.startsWith('images/') || path.startsWith('http')) ? path : `images/${path}`;
        }

        const townIcons = {
            "Tir Chonaill": "tradeposts/Commerce_Tir_Chonaill_Icon.png", "Dunbarton": "tradeposts/Commerce_Dunbarton_Icon.png",
            "Bangor": "tradeposts/Commerce_Bangor_Icon.png", "Emain Macha": "tradeposts/Commerce_Emain_Macha_Icon.png",
            "Taillteann": "tradeposts/Commerce_Taillteann_Icon.png", "Tara": "tradeposts/Commerce_Tara_Icon.png",
            "Cobh": "tradeposts/Commerce_Port_Cobh_Icon.png", "Belvast": "tradeposts/Commerce_Commonwealth_of_Belvast_Icon.png",
            "Qilla": "tradeposts/Commerce_Qilla_Icon.png", "Cor": "tradeposts/Commerce_Cor_Icon.png",
            "Vales": "tradeposts/Commerce_Vales_Icon.png", "Filia": "tradeposts/Commerce_Filia_Icon.png",
            "Karu Forest": "tradeposts/Commerce_Karu_Forest_Icon.png", "Oasis": "tradeposts/Commerce_Oasis_Icon.png",
            "Lake Calida": "tradeposts/Commerce_Calida_Icon.png", "Pera Volcano": "tradeposts/Commerce_Pera_Icon.png",
            "Scathach Beach": "tradeposts/Commerce_Beach_of_Scathach_Icon.png"
        };

        const transportData = {
            "Back Pack": { slots: 4, weight: 400 }, "Hand Cart": { slots: 6, weight: 800 },
            "Wagon": { slots: 8, weight: 900 }, "Elephant": { slots: 7, weight: 1700 },
            "Husky": { slots: 11, weight: 700 }, "Camel": { slots: 7, weight: 1400 },
            "Skiff": { slots: 8, weight: 1200 }, "Air Ship": { slots: 18, weight: 2500 }
        };

        const citiesByType = {
            "Normal": ["Tir Chonaill", "Dunbarton", "Bangor", "Emain Macha", "Taillteann", "Tara", "Cobh", "Belvast", "Qilla", "Cor", "Vales", "Filia"],
            "Barter": ["Karu Forest", "Oasis", "Lake Calida", "Pera Volcano", "Scathach Beach"],
            "Group": ["Qilla", "Filia", "Cor", "Vales"]
        };

        const masteryRanks = { "1": 0.15, "2": 0.14, "3": 0.13, "4": 0.12, "5": 0.11, "6": 0.10, "7": 0.09, "8": 0.08, "9": 0.07, "A": 0.06, "B": 0.05, "C": 0.04, "D": 0.03, "E": 0.02, "F": 0.01 };

        const guaranteeLetters = {
            "None": { normal: 0, barter: 0, fine_normal: 0, fine_barter: 0 },
            "Ogre": { normal: 0.30, barter: 0.15, fine_normal: 0.90, fine_barter: 0.45 },
            "Goblin": { normal: 0.40, barter: 0.20, fine_normal: 1.20, fine_barter: 0.60 },
            "Imp": { normal: 0.50, barter: 0.25, fine_normal: 1.50, fine_barter: 0.75 },
            "Irusan's (Special)": { normal: 3.00, barter: 0.75, fine_normal: 3.00, fine_barter: 0.75 }
        };

        const marketData = {
            "Normal": {
                "Tir Chonaill": [
                    { name: "Baby Potion", buy: 11, weight: 1, max: 35, limit: Infinity, img: "tradeposts/normal/tir/Baby_Potion_Icon.png" },
                    { name: "Diet Potion", buy: 26, weight: 1, max: 30, limit: Infinity, img: "tradeposts/normal/tir/Diet_Potion_Icon.png" },
                    { name: "Snore Potion", buy: 62, weight: 2, max: 26, limit: Infinity, img: "tradeposts/normal/tir/Snore_Prevention_Potion_Icon.png" },
                    { name: "Ginseng", buy: 134, weight: 3, max: 22, limit: Infinity, img: "tradeposts/normal/tir/Wild_Ginseng_Potion_Icon.png" },
                    { name: "Lovely Potion", buy: 158, weight: 3, max: 25, limit: Infinity, img: "tradeposts/normal/tir/Lovely_Potion_Icon.png" }
                ],
                "Dunbarton": [
                    { name: "Spider Gloves", buy: 44, weight: 4, max: 14, limit: Infinity, img: "tradeposts/normal/dunbarton/Spider_Gloves_Icon.png" },
                    { name: "Wool Boots", buy: 160, weight: 8, max: 10, limit: Infinity, img: "tradeposts/normal/dunbarton/Wool_Boots_Icon.png" },
                    { name: "Ogre Mask", buy: 91, weight: 4, max: 26, limit: Infinity, img: "tradeposts/normal/dunbarton/Ogre_Executioner_Mask_Icon.png" },
                    { name: "Incubus Suit", buy: 536, weight: 25, max: 5, limit: Infinity, img: "tradeposts/normal/dunbarton/Incubus_Suit_Icon.png" },
                    { name: "Succubus Swimsuit", buy: 718, weight: 6, max: 5, limit: Infinity, img: "tradeposts/normal/dunbarton/Succubus_Swimsuit_Icon.png" }
                ],
                "Bangor": [
                    { name: "Bangor Coal", buy: 45, weight: 8, max: 10, limit: Infinity, img: "tradeposts/normal/bangor/Bangor_Coal_Icon.png" },
                    { name: "Marble", buy: 301, weight: 20, max: 10, limit: Infinity, img: "tradeposts/normal/bangor/Marble_Icon.png" },
                    { name: "Topaz", buy: 376, weight: 18, max: 12, limit: Infinity, img: "tradeposts/normal/bangor/Topaz_Icon.png" },
                    { name: "Highlander Ore", buy: 788, weight: 25, max: 8, limit: Infinity, img: "tradeposts/normal/bangor/Highlander_Ore_Icon.png" },
                    { name: "Lead", buy: 856, weight: 18, max: 16, limit: Infinity, img: "tradeposts/normal/bangor/Lead_Icon.png" }
                ],
                "Emain Macha": [
                    { name: "Berry Granola", buy: 10, weight: 3, max: 25, limit: Infinity, img: "tradeposts/normal/emain/Berry_Granola_Icon.png" },
                    { name: "Butter Beer", buy: 49, weight: 4, max: 30, limit: Infinity, img: "tradeposts/normal/emain/Butter_Beer_Icon.png" },
                    { name: "Smoked Animal", buy: 190, weight: 10, max: 40, limit: Infinity, img: "tradeposts/normal/emain/Smoked_Wild_Animal_Icon.png" },
                    { name: "Triple Pasta", buy: 94, weight: 4, max: 32, limit: Infinity, img: "tradeposts/normal/emain/Triple_Pasta_Icon.png" },
                    { name: "Whole BBQ", buy: 630, weight: 14, max: 12, limit: Infinity, img: "tradeposts/normal/emain/Whole_BBQ_Bear_Icon.png" }
                ],
                "Taillteann": [
                    { name: "Heat Crystal", buy: 11, weight: 2, max: 33, limit: Infinity, img: "tradeposts/normal/taillteann/Heat_Crystal_Icon.png" },
                    { name: "Music Box Stone", buy: 37, weight: 3, max: 24, limit: Infinity, img: "tradeposts/normal/taillteann/Music_Box_Preservation_Stone_Icon.png" },
                    { name: "Palala Crystal", buy: 130, weight: 6, max: 38, limit: Infinity, img: "tradeposts/normal/taillteann/Palala_Crystal_Icon.png" },
                    { name: "Circle Barrier Spikes", buy: 126, weight: 3, max: 30, limit: Infinity, img: "tradeposts/normal/taillteann/Circle_Barrier_Spike_Crystal_Icon.png" },
                    { name: "Alchemy Crystal", buy: 720, weight: 5, max: 8, limit: Infinity, img: "tradeposts/normal/taillteann/Alchemy_Crystal_Icon.png" }
                ],
                "Tara": [
                    { name: "Mini Dressing Table", buy: 205, weight: 15, max: 10, limit: Infinity, img: "tradeposts/normal/tara/Mini_Dressing_Table_Icon.png" },
                    { name: "Tea Table", buy: 896, weight: 38, max: 3, limit: Infinity, img: "tradeposts/normal/tara/Tea_Table_Icon.png" },
                    { name: "Rocking Chair", buy: 918, weight: 25, max: 5, limit: Infinity, img: "tradeposts/normal/tara/Rocking_Chair_Icon.png" },
                    { name: "Bunk Bed", buy: 3690, weight: 60, max: 3, limit: Infinity, img: "tradeposts/normal/tara/Bunk_Bed_Icon.png" },
                    { name: "Giant Wine Rack", buy: 8640, weight: 90, max: 2, limit: Infinity, img: "tradeposts/normal/tara/Giant_Wine_Rack_Icon.png" }
                ],
                "Cobh": [
                    { name: "Cobh Seaweed", buy: 11, weight: 2, max: 32, limit: Infinity, img: "tradeposts/normal/cobh/Cobh_Seaweed_Icon.png" },
                    { name: "Cobh Oyster", buy: 46, weight: 3, max: 26, limit: Infinity, img: "tradeposts/normal/cobh/Cobh_Oyster_Icon.png" },
                    { name: "Shark Fin", buy: 264, weight: 10, max: 25, limit: Infinity, img: "tradeposts/normal/cobh/Shark_Fin_Icon.png" },
                    { name: "Jellyfish", buy: 201, weight: 6, max: 30, limit: Infinity, img: "tradeposts/normal/cobh/Jelly_Fish_Icon.png" },
                    { name: "Neid Scale", buy: 187, weight: 2, max: 28, limit: Infinity, img: "tradeposts/normal/cobh/Neid_Scales_Icon.png" }
                ],
                "Belvast": [
                    { name: "Iron Whip", buy: 103, weight: 8, max: 15, limit: Infinity, img: "tradeposts/normal/belvast/Iron_Whip_Icon.png" },
                    { name: "Dark Sword", buy: 477, weight: 12, max: 10, limit: Infinity, img: "tradeposts/normal/belvast/Dark_Sword_Icon.png" },
                    { name: "Safe", buy: 9757, weight: 90, max: 2, limit: Infinity, img: "tradeposts/normal/belvast/Safe_Icon.png" },
                    { name: "Skeleton Armour", buy: 15546, weight: 115, max: 1, limit: Infinity, img: "tradeposts/normal/belvast/Skeleton_Ogre_Armor_Icon.png" },
                    { name: "Fake Helmet", buy: 4740, weight: 30, max: 6, limit: Infinity, img: "tradeposts/normal/belvast/Fake_Morgant_Helmet_Icon.png" }
                ],
                "Qilla": [
                    { name: "Mint Chocolate Powder", buy: 35, weight: 1, max: 60, limit: Infinity, img: "tradeposts/normal/qilla/Mint_Chocolate_Powder_Icon.png" },
                    { name: "Pomegranate", buy: 58, weight: 2, max: 50, limit: Infinity, img: "tradeposts/normal/qilla/Fresh_Pomegranate_Icon.png" },
                    { name: "Mana Tunnel Figure", buy: 102, weight: 2, max: 65, limit: Infinity, img: "tradeposts/normal/qilla/Mana_Tunnel_Figure_Icon.png" },
                    { name: "Exploration Rescue Kit", buy: 247, weight: 3, max: 38, limit: Infinity, img: "tradeposts/normal/qilla/Exploration_Rescue_Kit_Icon.png" },
                    { name: "Kaypi Cactus Essence", buy: 566, weight: 2, max: 26, limit: Infinity, img: "tradeposts/normal/qilla/Kaypi_Cactus_Essence_Icon.png" }
                ],
                "Filia": [
                    { name: "Small Glass Chunk", buy: 72, weight: 10, max: 60, limit: Infinity, img: "tradeposts/normal/filia/Small_Glass_Chunk_Icon.png" },
                    { name: "Cinnamon Perfume", buy: 564, weight: 22, max: 15, limit: Infinity, img: "tradeposts/normal/filia/Cinnamon_Perfume_Icon.png" },
                    { name: "Dried Saffron", buy: 906, weight: 25, max: 10, limit: Infinity, img: "tradeposts/normal/filia/Dried_Saffron_Icon.png" },
                    { name: "Longa Rock Salt", buy: 2342, weight: 40, max: 5, limit: Infinity, img: "tradeposts/normal/filia/Longa_Natural_Rock_Salt_Icon.png" },
                    { name: "Filia Jerky", buy: 1567, weight: 20, max: 12, limit: Infinity, img: "tradeposts/normal/filia/Filia_Jerky_Icon.png" }
                ],
                "Cor": [
                    { name: "Courcle Ruins Souvenir", buy: 8, weight: 2, max: 50, limit: Infinity, img: "tradeposts/normal/cor/Courcle_Ruins_Souvenir_Icon.png" },
                    { name: "Large Ritual Mask", buy: 61, weight: 3, max: 40, limit: Infinity, img: "tradeposts/normal/cor/Large_Ritual_Mask_Icon.png" },
                    { name: "La Terra Raspberry", buy: 56, weight: 2, max: 60, limit: Infinity, img: "tradeposts/normal/cor/La_Terra_Raspberry_Icon.png" },
                    { name: "Artifact Rest. Tool", buy: 81, weight: 2, max: 70, limit: Infinity, img: "tradeposts/normal/cor/Artifact_Restoration_Tool_Set_Icon.png" },
                    { name: "Courcle Natural Rubber", buy: 935, weight: 5, max: 8, limit: Infinity, img: "tradeposts/normal/cor/Courcle_Natural_Rubber_Icon.png" }
                ],
                "Vales": [
                    { name: "Vales Coat", buy: 30, weight: 1, max: 50, limit: Infinity, img: "tradeposts/normal/vales/Vales_Padded_Coat_Icon.png" },
                    { name: "Glacial Water", buy: 118, weight: 2, max: 35, limit: Infinity, img: "tradeposts/normal/vales/Natural_Glacial_Water_Icon.png" },
                    { name: "Ice Skates", buy: 216, weight: 1, max: 50, limit: Infinity, img: "tradeposts/normal/vales/Ice_Skates_Icon.png" },
                    { name: "Snowboard", buy: 1079, weight: 3, max: 20, limit: Infinity, img: "tradeposts/normal/vales/Snowboard_Icon.png" },
                    { name: "Vales Vodka", buy: 1204, weight: 2, max: 16, limit: Infinity, img: "tradeposts/normal/vales/Vales_Vodka_Icon.png" }
                ]
            },
            "Barter": {
                "Karu Forest": [
                    { name: "Wooden Table", buy: 0, weight: 15, max: 10, limit: 25, img: "tradeposts/barter/karu/Wooden_Table_Icon.png" },
                    { name: "Wooden Craft", buy: 0, weight: 15, max: 7, limit: 15, img: "tradeposts/barter/karu/Wooden_Craft_Icon.png" },
                    { name: "Stone Horse Statue", buy: 0, weight: 20, max: 7, limit: 10, img: "tradeposts/barter/karu/Stone_Horse_Statue_Icon.png" },
                    { name: "Karu Mushroom", buy: 0, weight: 25, max: 7, limit: 8, img: "tradeposts/barter/karu/Karu_Shiitake_Mushroom_Icon.png" },
                    { name: "Shellfish Fossil", buy: 0, weight: 30, max: 5, limit: 3, img: "tradeposts/barter/karu/Shellfish_Fossil_Icon.png" }
                ],
                "Oasis": [
                    { name: "Fine Sand", buy: 0, weight: 15, max: 10, limit: 25, img: "tradeposts/barter/oasis/Fine_Sand_Icon.png" },
                    { name: "Prison Ghost Wings", buy: 0, weight: 15, max: 7, limit: 15, img: "tradeposts/barter/oasis/Prison_Ghost_Wings_Icon.png" },
                    { name: "Oasis Painting", buy: 0, weight: 20, max: 7, limit: 10, img: "tradeposts/barter/oasis/Oasis_Painting_Icon.png" },
                    { name: "Cactus Flower", buy: 0, weight: 25, max: 7, limit: 8, img: "tradeposts/barter/oasis/Cactus_Flower_Icon.png" },
                    { name: "Giant Canine Fossil", buy: 0, weight: 30, max: 5, limit: 3, img: "tradeposts/barter/oasis/Giant_Canine_Fossil_Icon.png" }
                ],
                "Lake Calida": [
                    { name: "Elvan Egg", buy: 0, weight: 15, max: 10, limit: 25, img: "tradeposts/barter/calida/Elvan_Egg_Icon.png" },
                    { name: "Salmon", buy: 0, weight: 15, max: 7, limit: 15, img: "tradeposts/barter/calida/Calida_Salmon_Icon.png" },
                    { name: "Bath Bomb", buy: 0, weight: 20, max: 7, limit: 10, img: "tradeposts/barter/calida/Hot_Spring_Bath_Bomb_Icon.png" },
                    { name: "Large Tent", buy: 0, weight: 25, max: 7, limit: 8, img: "tradeposts/barter/calida/Large_Camping_Tent_Icon.png" },
                    { name: "Pink Salt", buy: 0, weight: 30, max: 5, limit: 3, img: "tradeposts/barter/calida/Pink_Salt_Icon.png" }
                ],
                "Pera Volcano": [
                    { name: "Mud Pack", buy: 0, weight: 15, max: 10, limit: 25, img: "tradeposts/barter/pera/Volcanic_Mud_Pack_Icon.png" },
                    { name: "Magma Stone", buy: 0, weight: 15, max: 7, limit: 15, img: "tradeposts/barter/pera/Magma_Stone_Icon.png" },
                    { name: "Ixion Horn", buy: 0, weight: 20, max: 7, limit: 10, img: "tradeposts/barter/pera/Ixion_Horn_Icon.png" },
                    { name: "Lizard Egg", buy: 0, weight: 25, max: 7, limit: 8, img: "tradeposts/barter/pera/Volcano_Lizard_Egg_Icon.png" },
                    { name: "Leopard Leather", buy: 0, weight: 30, max: 5, limit: 3, img: "tradeposts/barter/pera/Raspa_Black_Leopard_Leather_Icon.png" }
                ],
                "Scathach Beach": [
                    { name: "Ocean Tear", buy: 0, weight: 7, max: 15, limit: 100, img: "tradeposts/barter/scathach/Ocean_Tear.png" },
                    { name: "Alluring Stem", buy: 0, weight: 15, max: 10, limit: 100, img: "tradeposts/barter/scathach/Allure_Stem.png" },
                    { name: "Abyss Crystal", buy: 0, weight: 5, max: 15, limit: 100, img: "tradeposts/barter/scathach/Abyss_Crystal.png" },
                    { name: "Sage Crystal", buy: 0, weight: 10, max: 15, limit: 100, img: "tradeposts/barter/scathach/Sage_Crystal.png" },
                    { name: "River's Source", buy: 0, weight: 25, max: 10, limit: 100, img: "tradeposts/barter/scathach/River_Source.png" },
                    { name: "Night Leather", buy: 0, weight: 4, max: 30, limit: 100, img: "tradeposts/barter/scathach/Night_Sky_Leather.png" },
                    { name: "Fish", buy: 0, weight: 5, max: 20, limit: 100, img: "tradeposts/barter/scathach/Unidentified_Fish.png" },
                    { name: "Crystal Blade", buy: 0, weight: 15, max: 10, limit: 100, img: "tradeposts/barter/scathach/Crystal_Blade.png" }
                ]
            },
            "Group": {
                "Qilla": [
                    { name: "Building Lumber", buy: 571, weight: 15, max: 8, limit: 144, img: "tradeposts/group/qilla/Building_Lumber_Icon.png" },
                    { name: "Ancient Fossil Specimen", buy: 550, weight: 8, max: 10, limit: 180, img: "tradeposts/group/qilla/Ancient_Fossil_Specimen_Icon.png" },
                    { name: "Personal Camping Tent", buy: 951, weight: 20, max: 7, limit: 125, img: "tradeposts/group/qilla/Personal_Camping_Tent_Icon.png" },
                    { name: "Lutra Freshwater Eel", buy: 657, weight: 7, max: 11, limit: 198, img: "tradeposts/group/qilla/Lutra_Freshwater_Eel_Icon.png" },
                    { name: "Kaypi Red Clay", buy: 919, weight: 6, max: 8, limit: 144, img: "tradeposts/group/qilla/Kaypi_Red_Clay_Icon.png" }
                ],
                "Filia": [
                    { name: "Sun Hourglass", buy: 2003, weight: 70, max: 12, limit: 35, img: "tradeposts/group/filia/Sun_Hourglass_Icon.png" },
                    { name: "Shyllien Icebox", buy: 3724, weight: 120, max: 5, limit: 20, img: "tradeposts/group/filia/Shyllien_Icebox_Icon.png" },
                    { name: "Desert-Terrain Wheel", buy: 3078, weight: 90, max: 7, limit: 25, img: "tradeposts/group/filia/Desert-Terrain_Wheel_Icon.png" },
                    { name: "Filia Traditional Carpet", buy: 1486, weight: 35, max: 20, limit: 71, img: "tradeposts/group/filia/Filia_Traditional_Carpet_Icon.png" },
                    { name: "Gem Parasol", buy: 905, weight: 20, max: 25, limit: 125, img: "tradeposts/group/filia/Gem_Parasol_Icon.png" }
                ],
                "Cor": [
                    { name: "Lipai Pattern Textile", buy: 342, weight: 6, max: 15, limit: 270, img: "tradeposts/group/cor/Lipai_Pattern_Textile_Icon.png" },
                    { name: "Cor Honeycomb", buy: 474, weight: 12, max: 13, limit: 208, img: "tradeposts/group/cor/Cor_Honeycomb_Icon.png" },
                    { name: "Swamp Ash", buy: 717, weight: 18, max: 9, limit: 138, img: "tradeposts/group/cor/Swamp_Ash_Icon.png" },
                    { name: "Rosewood", buy: 1084, weight: 25, max: 10, limit: 100, img: "tradeposts/group/cor/Rosewood_Icon.png" },
                    { name: "Ebony", buy: 1358, weight: 28, max: 8, limit: 89, img: "tradeposts/group/cor/Ebony_Icon.png" }
                ],
                "Vales": [
                    { name: "Calida Flint", buy: 503, weight: 5, max: 10, limit: 180, img: "tradeposts/group/vales/Calida_Flint_Icon.png" },
                    { name: "Physis Sled", buy: 1238, weight: 10, max: 5, limit: 90, img: "tradeposts/group/vales/Physis_Sled_Icon.png" },
                    { name: "Portable Hand Warmer", buy: 723, weight: 2, max: 10, limit: 180, img: "tradeposts/group/vales/Portable_Hand_Warmer_Icon.png" },
                    { name: "Ice Statue", buy: 982, weight: 8, max: 8, limit: 144, img: "tradeposts/group/vales/Ice_Statue_Icon.png" },
                    { name: "Hillwen Commemorative Coin", buy: 604, weight: 4, max: 15, limit: 270, img: "tradeposts/group/vales/Hillwen_Commemorative_Coin_Icon.png" }
                ]
            }
        };

        // --- 2. STATE ---
        let currentItem = null;
        let publicPrices = {};
        let publicStocks = {};
        let townRanks = {}; 
        let transportOwnership = {
            "Hand Cart": false,
            "Wagon": false,
            "Elephant": false,
            "Husky": false,
            "Camel": false,
            "Skiff": false,
            "Air Ship": false
        };

        let currentUser = null;
        let saveTimeout = null;
        let rtdb = null;
        let auth = null;
        let skipRender = false; // Prevents focus loss when typing
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- 3. LOGIC ---
        function getStock(itemName) { return publicStocks[itemName] || 0; }
        function getPrice(itemName, city) { return publicPrices[`${itemName}_${city}`.replace(/[.#$[\]]/g, "_")] || 0; }

        function getDiscountedBuyPrice(base) {
            const r = parseInt(document.getElementById('merchant-rating-select').value, 10) || 1;
            const mD = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 1, 6: 1, 7: 2, 8: 2, 9: 3 }[r] || 0;
            const traderVal = parseInt(document.getElementById('trader-qty').value, 10) || 0;
            const trustVal = parseInt(document.getElementById('trustworthy-qty').value, 10) || 0;
            const gear = (traderVal * 3) + trustVal;
            return Math.floor(base * (1 - ((mD + gear) / 100)));
        }

        function getModifiedStats(mName) {
            const b = transportData[mName];
            if (!b) return { slots: 0, weight: 0 };
            let bW = 0, bS = 0;
            if (document.getElementById('gm-check').checked) { bW += 100; bS += 1; }
            if (mName !== "Air Ship" && document.getElementById('william-check').checked) { bW += 200; bS += 1; }
            if (mName === "Wagon" && document.getElementById('alpaca-check').checked) { bW += 200; bS += 2; }
            return { slots: b.slots + bS, weight: b.weight + bW };
        }

        function getActiveModifiers() {
            const commerceType = document.getElementById('commerce-type-select').value;
            const masteryRank = document.getElementById('mastery-rank').value;
            const masteryBonus = masteryRanks[masteryRank] || 0;
            
            const letterName = document.getElementById('letter-select').value;
            const isFine = document.getElementById('fine-letter-check').checked;
            const letterInfo = guaranteeLetters[letterName] || guaranteeLetters["None"];
            
            let letterMultiplier = 0;
            if (commerceType === "Barter") {
                letterMultiplier = isFine ? letterInfo.fine_barter : letterInfo.barter;
            } else {
                letterMultiplier = isFine ? letterInfo.fine_normal : letterInfo.normal;
            }

            let williamBonus = 0;
            if (document.getElementById('william-check').checked) {
                const like = parseInt(document.getElementById('william-likeability').value) || 0;
                if (like >= 240) williamBonus = 0.03;
                else if (like >= 130) williamBonus = 0.02;
                else if (like >= 80) williamBonus = 0.01;
            }

            return { totalMultiplier: (1 + masteryBonus + letterMultiplier + williamBonus) };
        }

        function calculateItemProfit(item, targetCity, sellPriceOverride = null) {
            const sellVal = sellPriceOverride !== null ? sellPriceOverride : getPrice(item.name, targetCity);
            const dBuy = getDiscountedBuyPrice(item.buy);
            const stats = getModifiedStats(document.getElementById('transport-dropdown').value);
            const load = Math.min(Math.floor(stats.weight / item.weight), stats.slots * item.max, item.limit);
            
            const baseProfit = (sellVal !== "") ? (sellVal - dBuy) * load : 0;
            const mods = getActiveModifiers();
            let finalProfit = baseProfit > 0 ? Math.floor(baseProfit * mods.totalMultiplier) : baseProfit;

            const commerceType = document.getElementById('commerce-type-select').value;
            const divisor = (commerceType === "Barter") ? 34 : 17;
            const score = Math.max(0, Math.floor(((sellVal - (item.buy || 0)) * load) / divisor));

            return { profit: finalProfit, score: score, load: load };
        }

        function getAvailableMounts() {
            const mounts = ['Back Pack'];
            const type = document.getElementById('commerce-type-select').value;
            Object.keys(transportOwnership).forEach(key => {
                if (transportOwnership[key]) {
                    if (key === 'Air Ship' && type !== 'Group') return;
                    mounts.push(key);
                }
            });
            return mounts;
        }

        function calculateBestRouteForVector(originCity, targetCities, originItems, forcedMount = null) {
            let best = null, maxP = -1;
            const mods = getActiveModifiers();
            targetCities.forEach(targetCity => {
                (forcedMount ? [forcedMount] : getAvailableMounts()).forEach(mKey => {
                    const stats = getModifiedStats(mKey);
                    let remWeight = stats.weight, remSlots = stats.slots, totalP = 0, itemsToBuy = [];
                    const potential = originItems.map(item => {
                        const unitP = (getPrice(item.name, targetCity) - getDiscountedBuyPrice(item.buy)) * (1 + (getPrice(item.name, targetCity) > getDiscountedBuyPrice(item.buy) ? (mods.totalMultiplier - 1) : 0));
                        return { ...item, unitP, eff: unitP / Math.max(1, item.weight) };
                    }).filter(i => i.unitP > 0).sort((a, b) => b.eff - a.eff);

                    potential.forEach(item => {
                        const stock = getStock(item.name);
                        let qty = Math.min(Math.floor(remWeight / item.weight), remSlots * item.max, item.limit, stock);
                        if (qty <= 0) return;
                        let slotsNeeded = Math.ceil(qty / item.max);
                        const stackProfit = Math.floor(qty * item.unitP);
                        itemsToBuy.push({ n: item.name, q: qty, p: stackProfit, img: item.img, s: slotsNeeded, maxPerSlot: item.max });
                        remWeight -= (qty * item.weight); remSlots -= slotsNeeded; totalP += stackProfit;
                    });
                    if (totalP > maxP) { maxP = totalP; best = { origin: originCity, dest: targetCity, mount: mKey, items: itemsToBuy, profit: totalP, maxSlots: stats.slots }; }
                });
            });
            return { best, maxP };
        }

        function runManifests() {
            const type = document.getElementById('commerce-type-select').value;
            const origin = document.getElementById('city-select').value;
            const targetPool = (type === "Barter" ? citiesByType["Normal"] : citiesByType[type]);
            const targets = targetPool.filter(c => c !== origin);
            const originItems = (marketData[type] && marketData[type][origin]) || [];
            
            const localResult = calculateBestRouteForVector(origin, targets, originItems, null);
            renderManifest(localResult.best, 'manifest-box', 'manifest-list', 'manifest-total');

            let globalBest = null, globalMax = -1;
            (citiesByType[type] || []).forEach(org => {
                const res = calculateBestRouteForVector(org, targetPool.filter(c => c !== org), (marketData[type] && marketData[type][org]) || []);
                if (res.maxP > globalMax) { globalMax = res.maxP; globalBest = res.best; }
            });
            const anchor = document.getElementById('global-manifest-anchor');
            if (!globalBest || globalMax <= 0) anchor.innerHTML = ''; else renderGlobalManifest(globalBest, anchor);
        }

        function renderManifest(trip, boxId, listId, totalId) {
            const box = document.getElementById(boxId), list = document.getElementById(listId), total = document.getElementById(totalId);
            if (!trip || trip.profit <= 0) {
                box.style.display = 'block';
                list.innerHTML = `<div style="color:#aaa; font-size:10px; padding:10px; text-align:center;">NO ROUTES</div>`;
                total.textContent = `PROFIT: 0`;
                return;
            }
            box.style.display = 'block';
            let slotHtml = '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
            let filled = 0;
            trip.items.forEach(item => {
                let rem = item.q;
                for (let i = 0; i < item.s; i++) {
                    const sqty = Math.min(item.maxPerSlot, rem); rem -= sqty;
                    slotHtml += `<div class="manifest-slot filled" style="background-image: url('${getImagePath(item.img)}');"><span class="slot-badge">${sqty}</span></div>`;
                    filled++;
                }
            });
            for (let i = filled; i < trip.maxSlots; i++) slotHtml += `<div class="manifest-slot empty"></div>`;
            list.innerHTML = `<div style="color:var(--accent); font-weight:bold;">DEST: ${trip.dest}</div><div style="font-size:10px; opacity:0.6; margin-bottom:10px;">UNIT: ${trip.mount}</div>${slotHtml}</div>`;
            total.textContent = `TOTAL: ${trip.profit.toLocaleString()}`;
        }

        function renderGlobalManifest(trip, container) {
            let slotHtml = '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
            trip.items.forEach(item => {
                let rem = item.q;
                for (let i = 0; i < item.s; i++) {
                    const sqty = Math.min(item.maxPerSlot, rem); rem -= sqty;
                    slotHtml += `<div class="manifest-slot filled" style="background-image: url('${getImagePath(item.img)}');"><span class="slot-badge">${sqty}</span></div>`;
                }
            });
            container.innerHTML = `<div class="recommendation-box"><div class="rec-title" style="color:#a29bfe;">GLOBAL_BEST</div><div style="color:var(--accent); font-weight:bold;">${trip.origin} â†’ ${trip.dest}</div><div style="font-size:10px; opacity:0.6; margin-bottom:10px;">UNIT: ${trip.mount}</div>${slotHtml}</div><div class="manifest-footer">PROFIT: ${trip.profit.toLocaleString()}</div></div>`;
        }

        function refreshUI() {
            if (document.activeElement && document.activeElement.classList.contains('price-input')) return;
            updateMarketItems(); showPrices(); updatePreview(); updateRecommendationAndStats(); updateTownIcon(); runManifests();
            const wCheck = document.getElementById('william-check');
            const wBox = document.getElementById('william-like-box');
            if(wCheck && wBox) wBox.style.display = wCheck.checked ? 'flex' : 'none';
        }

        function updatePreview() {
            if (!currentItem) return;
            document.getElementById('center-item-icon').style.backgroundImage = `url('${getImagePath(currentItem.img)}')`;
            document.getElementById('center-item-title').textContent = currentItem.name;
            document.getElementById('max-inventory-display').textContent = ` Weight: ${currentItem.weight} â€¢ Stack: ${currentItem.max} â€¢ Buy: ${currentItem.buy}`;
        }

        function updateTownIcon() {
            const avatar = document.getElementById('origin-town-icon');
            const city = document.getElementById('city-select').value;
            if (avatar && townIcons[city]) avatar.style.backgroundImage = `url('${getImagePath(townIcons[city])}')`;
        }

        function updateMarketItems() {
            const container = document.getElementById('market-items-container');
            container.innerHTML = '';
            const type = document.getElementById('commerce-type-select').value;
            const city = document.getElementById('city-select').value;
            if(!city) return; 

            const searchTerm = document.getElementById('global-search').value.toLowerCase().trim();
            document.getElementById('clear-search').style.display = searchTerm ? 'block' : 'none';

            let items = [];
            if (searchTerm) {
                (citiesByType[type] || []).forEach(town => {
                    ((marketData[type] && marketData[type][town]) || []).forEach(item => {
                        if (item.name.toLowerCase().includes(searchTerm)) items.push({ ...item, _townName: town });
                    });
                });
            } else { items = (marketData[type] && marketData[type][city]) || []; }

            if (items.length > 0 && (!currentItem || !items.find(i => i.name === currentItem.name))) { currentItem = items[0]; updatePreview(); }

            items.forEach(item => {
                const isSelected = currentItem && currentItem.name === item.name;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item' + (isSelected ? ' selected-item' : '');
                const cStock = getStock(item.name);
                itemDiv.innerHTML = `<div class="item-list-icon-box" style="background-image: url('${getImagePath(item.img)}')"></div><div class="item-list-content"><div><span class="item-name">${item.name}</span>${item._townName ? `<span class="item-town-badge">ðŸ“ ${item._townName}</span>` : ''}</div><div class="stock-input-row"><span style="font-size:9px; color:#aaa;">STOCK</span><input type="number" class="qty-input" value="${cStock || ''}" placeholder="0" onclick="event.stopPropagation()" onchange="updateStock('${item.name.replace(/'/g, "\\'")}', this.value)"></div></div>`;
                itemDiv.addEventListener('click', () => { currentItem = item; refreshUI(); });
                container.appendChild(itemDiv);
            });
        }

        function showPrices() {
            const list = document.getElementById('profit-list');
            if (document.activeElement && document.activeElement.classList.contains('price-input')) return;
            list.innerHTML = '';
            if (!currentItem) return;
            const type = document.getElementById('commerce-type-select').value;
            const origin = currentItem._townName || document.getElementById('city-select').value;
            (type === "Barter" ? citiesByType["Normal"] : citiesByType[type]).filter(c => c !== origin).forEach(city => {
                const sellVal = getPrice(currentItem.name, city);
                const res = calculateItemProfit(currentItem, city, sellVal);
                const row = document.createElement('div');
                row.className = 'market-row';
                row.innerHTML = `<div class="market-left"><b>${city}</b></div><div class="col-price"><input type="number" class="price-input" value="${sellVal || ''}" oninput="updatePrice('${city}', this.value)"></div><div class="market-profit-col"><span class="${res.profit < 0 ? 'profit-val negative' : 'profit-val'}">${res.profit.toLocaleString()}</span></div><div class="market-score-col"><span class="season-val">${res.score.toLocaleString()}</span></div>`;
                list.appendChild(row);
            });
        }

        function updateTransportDropdown() {
            const dropdown = document.getElementById('transport-dropdown');
            const current = dropdown.value || "Back Pack";
            const available = getAvailableMounts();
            dropdown.innerHTML = available.map(m => `<option value="${m}">${m}</option>`).join('');
            if (available.includes(current)) dropdown.value = current; else dropdown.value = "Back Pack";
        }

        function updateRecommendationAndStats() { /* handled in refreshUI */ }

        // --- FIREBASE WRAPPERS ---
        function updatePrice(city, val) {
            if (!currentItem) return;
            const sellVal = parseInt(val, 10) || 0;
            const priceKey = `${currentItem.name}_${city}`.replace(/[.#$[\]]/g, "_");
            publicPrices[priceKey] = sellVal;
            
            skipRender = true; // Fix focus loss
            
            // Try to update DB, ignore errors
            if(rtdb) { try { rtdb.ref(`public_commerce/prices/${priceKey}`).set(sellVal); } catch(e){} }
            // Optimistic Row Update
            const activeInput = document.activeElement;
            if (activeInput && activeInput.classList.contains('price-input')) {
                const row = activeInput.closest('.market-row');
                if (row) {
                    const result = calculateItemProfit(currentItem, city, sellVal);
                    const profitEl = row.querySelector('.market-profit-col span');
                    const scoreEl = row.querySelector('.market-score-col span');
                    if (profitEl) { profitEl.textContent = result.profit.toLocaleString(); profitEl.className = result.profit < 0 ? 'profit-val negative' : 'profit-val'; }
                    if (scoreEl) { scoreEl.textContent = result.score.toLocaleString(); }
                }
            }
            runManifests();
        }

        function updateStock(itemName, quantity) {
            const qty = parseInt(quantity) || 0;
            publicStocks[itemName] = qty;
            
            skipRender = true; // Fix focus loss
            
            if(rtdb) { try { rtdb.ref(`public_commerce/stocks/${itemName}`).set(qty); } catch(e){} }
            refreshUI();
        }

        function savePrefs() {
            const prefs = {
                type: document.getElementById('commerce-type-select').value,
                city: document.getElementById('city-select').value,
                mount: document.getElementById('transport-dropdown').value,
                gm: document.getElementById('gm-check').checked,
                william: document.getElementById('william-check').checked,
                williamLike: document.getElementById('william-likeability').value, 
                alpaca: document.getElementById('alpaca-check').checked,
                trader: document.getElementById('trader-qty').value,
                trust: document.getElementById('trustworthy-qty').value,
                mastery: document.getElementById('mastery-rank').value,
                letter: document.getElementById('letter-select').value,
                fineLetter: document.getElementById('fine-letter-check').checked,
                transports: transportOwnership
            };
            localStorage.setItem('mabi_prefs', JSON.stringify(prefs));
            localStorage.setItem('mabi_transports', JSON.stringify(transportOwnership));
            if (currentUser && rtdb) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => { try { rtdb.ref(`users/${currentUser.uid}/settings`).update(prefs); } catch(e){} }, 1000);
            }
        }

        function saveTownRanks() {
            localStorage.setItem('mabi_ranks', JSON.stringify(townRanks));
            if (currentUser && rtdb) { try { rtdb.ref(`users/${currentUser.uid}/town_ranks`).set(townRanks); } catch(e){} }
        }

        function updateCityContext() {
            const city = document.getElementById('city-select').value;
            if(!city) return;
            document.getElementById('merchant-rating-select').value = townRanks[city] || "1";
            refreshUI();
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const saved = JSON.parse(localStorage.getItem('mabi_prefs')) || {};
            try { townRanks = JSON.parse(localStorage.getItem('mabi_ranks')) || {}; } catch(e){ townRanks = {}; }
            
            // 1. Setup Dropdowns
            const mSelect = document.getElementById('mastery-rank');
            mSelect.innerHTML = Object.keys(masteryRanks).map(r => `<option value="${r}">Rank ${r} (+${Math.round(masteryRanks[r]*100)}%)</option>`).join('');
            mSelect.value = "F";
            const lSelect = document.getElementById('letter-select');
            lSelect.innerHTML = ["None", "Ogre", "Goblin", "Imp", "Irusan's (Special)"].map(n => `<option value="${n}">${n}</option>`).join('');
            lSelect.value = "None";

            // 2. Setup Toggles
            document.querySelectorAll('.transport-toggle').forEach(toggle => {
                toggle.onchange = (e) => { transportOwnership[toggle.dataset.mount] = e.target.checked; savePrefs(); updateTransportDropdown(); refreshUI(); };
            });

            // 3. UI Logic Listeners
            const typeSelect = document.getElementById('commerce-type-select');
            const citySelect = document.getElementById('city-select');
            typeSelect.onchange = (e) => {
                const valid = citiesByType[e.target.value];
                citySelect.innerHTML = valid.map(c => `<option value="${c}">${c}</option>`).join('');
                if(valid.length > 0) citySelect.value = valid[0];
                updateCityContext(); updateTransportDropdown();
            };
            citySelect.onchange = () => { updateCityContext(); savePrefs(); };
            document.getElementById('merchant-rating-select').onchange = function() { townRanks[citySelect.value] = this.value; saveTownRanks(); refreshUI(); };
            
            ['transport-dropdown', 'trader-qty', 'trustworthy-qty', 'mastery-rank', 'letter-select', 'fine-letter-check', 'gm-check', 'william-likeability'].forEach(id => {
                const el = document.getElementById(id);
                el.onchange = () => { refreshUI(); savePrefs(); };
                if (el.tagName === 'INPUT') el.oninput = () => { refreshUI(); savePrefs(); };
            });
            document.getElementById('william-check').onchange = function() { if (this.checked) document.getElementById('alpaca-check').checked = false; refreshUI(); savePrefs(); };
            document.getElementById('alpaca-check').onchange = function() { if (this.checked) document.getElementById('william-check').checked = false; refreshUI(); savePrefs(); };
            document.getElementById('global-search').oninput = refreshUI;
            document.getElementById('clear-search').onclick = () => { document.getElementById('global-search').value = ''; refreshUI(); };

            // 4. RESTORE PREFS & INITIAL RENDER (CRITICAL: Runs before Firebase)
            if (saved.type && citiesByType[saved.type]) typeSelect.value = saved.type; else typeSelect.value = "Normal";
            
            const validCities = citiesByType[typeSelect.value];
            citySelect.innerHTML = validCities.map(c => `<option value="${c}">${c}</option>`).join('');
            if (saved.city && validCities.includes(saved.city)) citySelect.value = saved.city; else if (validCities.length > 0) citySelect.value = validCities[0];

            if (saved.mount) document.getElementById('transport-dropdown').value = saved.mount;
            if (saved.trader) document.getElementById('trader-qty').value = saved.trader;
            if (saved.trust) document.getElementById('trustworthy-qty').value = saved.trust;
            if (saved.mastery) document.getElementById('mastery-rank').value = saved.mastery;
            if (saved.letter) document.getElementById('letter-select').value = saved.letter;
            document.getElementById('fine-letter-check').checked = !!saved.fineLetter;
            document.getElementById('gm-check').checked = !!saved.gm;
            document.getElementById('william-check').checked = !!saved.william;
            if(saved.williamLike) document.getElementById('william-likeability').value = saved.williamLike;
            document.getElementById('alpaca-check').checked = !!saved.alpaca;
            if(saved.transports) {
                transportOwnership = saved.transports;
                // Sync checkboxes
                Object.keys(transportOwnership).forEach(key => {
                    const toggle = document.querySelector(`.transport-toggle[data-mount="${key}"]`);
                    if(toggle) toggle.checked = transportOwnership[key];
                });
            }
            
            updateCityContext();
            updateTransportDropdown();
            // RENDER NOW
            refreshUI();

            // 5. Firebase Init (Graceful)
            function initApp() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyC7A3Rzi-VddhqZiFGjHjjqBwCdX1ks6yM",
                        authDomain: "mabinogi-tracker.firebaseapp.com",
                        databaseURL: "https://mabinogi-tracker-default-rtdb.firebaseio.com",
                        projectId: "mabinogi-tracker",
                        storageBucket: "mabinogi-tracker.firebasestorage.app",
                        messagingSenderId: "267690802644",
                        appId: "1:267690802644:web:fccdd005d5c8990504ea41",
                        measurementId: "G-VBDBKQ3M1B"
                    };
                    firebase.initializeApp(firebaseConfig);
                    rtdb = firebase.database();
                    auth = firebase.auth();
                    
                    // Public Data Listeners
                    rtdb.ref('public_commerce/prices').on('value', (s) => { 
                        if (skipRender) { skipRender = false; return; }
                        publicPrices = s.val() || {}; refreshUI(); 
                    });
                    rtdb.ref('public_commerce/stocks').on('value', (s) => { 
                        if (skipRender) { skipRender = false; return; }
                        publicStocks = s.val() || {}; refreshUI(); 
                    });

                    // User Data
                    if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) auth.signInWithCustomToken(__initial_auth_token);
                    else auth.signInAnonymously().catch(e => console.log("Auth skipped (offline)"));

                    auth.onAuthStateChanged((user) => {
                        currentUser = user;
                        if (user) {
                            rtdb.ref(`users/${user.uid}/settings`).on('value', (s) => { 
                                if(s.val()) { 
                                    const d=s.val(); 
                                    if(d.transports) {
                                        transportOwnership=d.transports; 
                                        // Sync Checkboxes from Firebase update
                                        Object.keys(transportOwnership).forEach(key => {
                                            const toggle = document.querySelector(`.transport-toggle[data-mount="${key}"]`);
                                            if(toggle) toggle.checked = transportOwnership[key];
                                        });
                                    }
                                    refreshUI(); 
                                } 
                            });
                            rtdb.ref(`users/${user.uid}/town_ranks`).on('value', (s) => { if(s.val()) { townRanks = s.val(); updateCityContext(); } });
                        }
                    });
                } catch(e) {
                    console.log("Running in offline mode (Firebase init failed)");
                }
            }

            initApp();
        });
    </script>
</body>
</html>
